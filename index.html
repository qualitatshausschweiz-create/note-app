<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />

  <!-- ============================================================
       TITOLO + RESPONSIVE
       ============================================================ -->
  <title>Sandro Premium Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ============================================================
       STILI BASE (CSS verr√† completato nel BLOCCO 2/4)
       ============================================================ -->
  <style>
    /* Placeholder: il CSS completo arriva nel BLOCCO 2/4 */
  </style>
</head>

<body>

<!-- ============================================================
     OVERLAY PIN (schermata iniziale di sicurezza)
     ============================================================ -->
<div id="pinOverlay">
  <div class="pinCard glass">

    <!-- Titolo PIN -->
    <div class="pinTitle">PIN</div>

    <!-- Cerchi che si riempiono quando digiti -->
    <div class="pinCircles">
      <div class="pinCircle"></div>
      <div class="pinCircle"></div>
      <div class="pinCircle"></div>
      <div class="pinCircle"></div>
    </div>

    <!-- Errore PIN -->
    <div id="pinError" class="pinError"></div>

    <!-- Tastierino numerico -->
    <div class="pinPad">
      <button class="pinKey" data-digit="1">1</button>
      <button class="pinKey" data-digit="2">2</button>
      <button class="pinKey" data-digit="3">3</button>
      <button class="pinKey" data-digit="4">4</button>
      <button class="pinKey" data-digit="5">5</button>
      <button class="pinKey" data-digit="6">6</button>
      <button class="pinKey" data-digit="7">7</button>
      <button class="pinKey" data-digit="8">8</button>
      <button class="pinKey" data-digit="9">9</button>
      <div></div>
      <button class="pinKey" data-digit="0">0</button>
      <button id="pinBackspace">‚å´</button>
    </div>

  </div>
</div>

<!-- ============================================================
     APP SHELL (contenitore principale dell‚Äôapp)
     ============================================================ -->
<div class="appShell">

  <!-- ============================================================
       HEADER MODERNO CON 4 ICONE A DESTRA
       ============================================================ -->
  <div class="glass">
    <div class="header">

      <!-- Titolo dell‚Äôapp -->
      <div id="appTitle">
        Note
        <span class="sub">Premium</span>
      </div>

      <!-- Pulsanti header -->
      <div class="headerButtons">

        <!-- Lingua -->
        <button id="langBtn" class="iconBtn">üåê</button>

        <!-- Tema chiaro/scuro -->
        <button id="themeBtn" class="iconBtn">‚òæ</button>

        <!-- Backup manuale -->
        <button id="backupBtn" class="iconBtn">üõü</button>

        <!-- Impostazioni -->
        <button id="settingsBtn" class="iconBtn">‚öôÔ∏é</button>

      </div>
    </div>

    <!-- ============================================================
         CATEGORIE ORIZZONTALI (scrollabili)
         ============================================================ -->
    <div class="categories">
      <div class="cat active" data-cat="all">All</div>
      <div class="cat" data-cat="work">Work</div>
      <div class="cat" data-cat="personal">Personal</div>
      <div class="cat" data-cat="ideas">Ideas</div>
      <div class="cat" data-cat="todo">To‚ÄëDo</div>
    </div>

    <!-- ============================================================
         LISTA NOTE
         ============================================================ -->
    <div class="notesCard">
      <div id="notesList"></div>

      <!-- Pulsante per aggiungere una nuova nota -->
      <div class="addNoteBar">
        <button id="addNoteBtn">Ôºã Nuova</button>
      </div>
    </div>

  </div> <!-- fine glass header+lista -->

</div> <!-- fine appShell -->
<!-- ============================================================
     EDITOR NOTE (creazione e modifica)
     ============================================================ -->
<div id="noteEditor" style="display:none;">
  <div class="editorCard glass">

    <!-- Titolo dinamico: "Nuova nota" oppure "Modifica nota" -->
    <div id="editorTitle">Nuova nota</div>

    <!-- Campi di input -->
    <div class="editorInputs">
      <input id="noteTitleInput" type="text" placeholder="Titolo" />
      <textarea id="noteText" placeholder="Scrivi qui..."></textarea>
    </div>

    <!-- Palette colori -->
    <div class="paletteRow">

      <!-- Pulsanti per scegliere la palette -->
      <div class="paletteBtns">
        <button class="paletteBtn" data-pal="warm">Warm</button>
        <button class="paletteBtn" data-pal="cool">Cool</button>
        <button class="paletteBtn" data-pal="pastel">Pastel</button>
        <button class="paletteBtn" data-pal="mix">Mix</button>
      </div>

      <!-- Colori generati dinamicamente -->
      <div id="colorRow"></div>
    </div>

    <!-- Pulsanti azione -->
    <div class="editorActions">

      <!-- A sinistra: elimina -->
      <div class="editorLeft">
        <button id="deleteNoteBtn" class="btnDanger">üóë Elimina</button>
      </div>

      <!-- A destra: annulla + salva -->
      <div class="editorRight">
        <button id="cancelBtn" class="btnGhost">Annulla</button>
        <button id="saveBtn" class="btnPrimary">Salva</button>
      </div>

    </div>

  </div>
</div>

<!-- ============================================================
     PANNELLO IMPOSTAZIONI
     ============================================================ -->
<div id="settingsPanel" style="display:none;">
  <div class="settingsCard glass">

    <!-- Header impostazioni -->
    <div class="settingsHeader">
      <div class="settingsTitle">Impostazioni</div>
      <div class="settingsClose">‚úï</div>
    </div>

    <!-- Lista impostazioni -->
    <div class="settingsList">

      <!-- Tema -->
      <div id="settingsTheme" class="settingsItem">
        <span class="label">Tema</span><span class="value">Toggle</span>
      </div>

      <!-- AMOLED -->
      <div id="settingsAmoled" class="settingsItem">
        <span class="label">AMOLED</span><span class="value">On/Off</span>
      </div>

      <!-- Font -->
      <div id="settingsFont" class="settingsItem">
        <span class="label">Font</span><span class="value">Cycle</span>
      </div>

      <!-- Dimensione testo -->
      <div id="settingsTextSize" class="settingsItem">
        <span class="label">Dimensione testo</span><span class="value">Cycle</span>
      </div>

      <!-- Colore accento -->
      <div id="settingsAccent" class="settingsItem">
        <span class="label">Colore accento</span><span class="value">Cycle</span>
      </div>

      <!-- Sfocatura -->
      <div id="settingsBlur" class="settingsItem">
        <span class="label">Sfocatura</span><span class="value">Cycle</span>
      </div>

      <!-- Animazioni -->
      <div id="settingsAnimations" class="settingsItem">
        <span class="label">Animazioni</span><span class="value">On/Off</span>
      </div>

      <!-- Haptics -->
      <div id="settingsHaptics" class="settingsItem">
        <span class="label">Haptics</span><span class="value">On/Off</span>
      </div>

      <!-- Esporta -->
      <div id="settingsExport" class="settingsItem">
        <span class="label">Esporta</span><span class="value">JSON</span>
      </div>

      <!-- Importa -->
      <div id="settingsImport" class="settingsItem">
        <span class="label">Importa</span><span class="value">JSON</span>
      </div>

      <!-- Archivio -->
      <div id="settingsArchive" class="settingsItem">
        <span class="label">Archivio</span><span class="value">Apri</span>
      </div>

      <!-- Cambia PIN -->
      <div id="settingsChangePin" class="settingsItem">
        <span class="label">Cambia PIN</span><span class="value">Manuale</span>
      </div>

      <!-- Reset app -->
      <div id="settingsResetApp" class="settingsItem settingsDanger">
        <span class="label">Reset app</span><span class="value">Danger</span>
      </div>

    </div>
  </div>
</div>

<!-- ============================================================
     POPUP ARCHIVIO
     ============================================================ -->
<div id="archivePopup" style="display:none;">
  <div class="popupCard glass">

    <div class="popupHeader">
      <div class="popupTitle">Archivio</div>
      <div id="archiveCloseBtn" class="popupClose">‚úï</div>
    </div>

    <!-- Lista note archiviate -->
    <div id="archiveList"></div>

  </div>
</div>

<!-- ============================================================
     POPUP RESET APP
     ============================================================ -->
<div id="resetPopup" style="display:none;">
  <div class="popupCard glass">

    <div class="popupHeader">
      <div class="popupTitle">Reset app?</div>
    </div>

    <div style="font-size:13px;color:var(--text-soft);margin-top:4px;">
      Tutte le note, archivio, impostazioni e PIN verranno eliminati.
    </div>

    <div class="popupActions">
      <button id="resetCancelBtn" class="btnGhost">Annulla</button>
      <button id="resetConfirmBtn" class="btnDanger">S√¨, elimina</button>
    </div>

  </div>
</div>

<!-- ============================================================
     BANNER (notifiche brevi)
     ============================================================ -->
<div id="bannerMsg"></div>

<!-- ============================================================
     JAVASCRIPT (verr√† inserito nel BLOCCO 3/4)
     ============================================================ -->
<script>
  /* Il tuo JavaScript completo arriver√† nel BLOCCO 3/4 */
</script>

</body>
</html>
/* ============================================================
   VARIABILI GLOBALI (colori, blur, animazioni)
   ============================================================ */
:root {
  --bg: #050814;
  --bg-soft: rgba(10, 14, 30, 0.9);
  --card: rgba(18, 24, 48, 0.9);
  --border: rgba(255, 255, 255, 0.06);
  --text: #f7f9ff;
  --text-soft: #a5b0d0;
  --accent: #4f8cff;
  --accent-light: #4f8cff55;
  --accent-glow: #4f8cff55;
  --danger: #ff4b5c;
  --blur-amount: 18px;
  --text-size: 16px;
  --anim: 1;
}

/* ============================================================
   RESET + BASE
   ============================================================ */
* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  margin: 0;
  font-family: -apple-system, system-ui, sans-serif;
  background: radial-gradient(circle at top, #1b2a4a 0, #050814 55%, #000 100%);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  align-items: stretch;
  justify-content: center;
  font-size: var(--text-size);
  transition: background 0.3s ease;
}

/* Tema scuro */
body.dark {
  background: radial-gradient(circle at top, #0f172a 0, #020617 60%, #000 100%);
}

/* AMOLED puro */
body.amoled {
  background: #000;
}

/* ============================================================
   CONTENITORE PRINCIPALE
   ============================================================ */
.appShell {
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  padding: 18px 14px 26px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

/* ============================================================
   EFFETTO VETRO (glassmorphism)
   ============================================================ */
.glass {
  background: var(--bg-soft);
  border-radius: 22px;
  border: 1px solid var(--border);
  backdrop-filter: blur(var(--blur-amount));
  -webkit-backdrop-filter: blur(var(--blur-amount));
  box-shadow:
    0 18px 40px rgba(0, 0, 0, 0.7),
    0 0 0 1px rgba(255, 255, 255, 0.02);
}

/* ============================================================
   HEADER
   ============================================================ */
.header {
  padding: 14px 16px 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

#appTitle {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 0.02em;
  display: flex;
  flex-direction: column;
}

#appTitle .sub {
  font-size: 11px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.16em;
  margin-top: 2px;
}

/* Pulsanti icona header */
.headerButtons {
  display: flex;
  gap: 8px;
  align-items: center;
}

.iconBtn {
  width: 32px;
  height: 32px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: radial-gradient(circle at top, #1f2937 0, #020617 80%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-soft);
  font-size: 15px;
  cursor: pointer;
  transition: transform 0.18s ease;
}

.iconBtn:active {
  transform: scale(0.94);
}

/* ============================================================
   CATEGORIE
   ============================================================ */
.categories {
  padding: 0 10px 10px;
  display: flex;
  gap: 8px;
  overflow-x: auto;
  scrollbar-width: none;
}

.categories::-webkit-scrollbar {
  display: none;
}

.cat {
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid var(--border);
  font-size: 12px;
  color: var(--text-soft);
  cursor: pointer;
  white-space: nowrap;
  background: rgba(15, 23, 42, 0.9);
  transition: background 0.2s ease;
}

.cat.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent-light);
}

/* ============================================================
   LISTA NOTE
   ============================================================ */
.notesCard {
  padding: 10px 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#notesList {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 55vh;
  overflow-y: auto;
  padding-right: 4px;
}

.noteItem {
  border-radius: 18px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid var(--border);
  padding: 10px 11px 9px;
  cursor: pointer;
  border-left: 3px solid var(--accent);
  transition: transform 0.15s ease;
}

.noteItem:active {
  transform: scale(0.97);
}

.noteTitleRow {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.noteTitle {
  font-size: 15px;
  font-weight: 600;
  color: #e5edff;
}

.noteMeta {
  font-size: 11px;
  color: var(--text-soft);
}

.noteTextPreview {
  font-size: 13px;
  color: var(--text-soft);
  margin-top: 4px;
}

/* ============================================================
   PULSANTE NUOVA NOTA
   ============================================================ */
.addNoteBar {
  display: flex;
  justify-content: flex-end;
  padding: 0 2px 2px;
}

#addNoteBtn {
  border-radius: 999px;
  padding: 7px 14px;
  border: none;
  background: linear-gradient(135deg, var(--accent), #7c5cff);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

/* ============================================================
   EDITOR NOTE
   ============================================================ */
#noteEditor {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.editorCard {
  width: 100%;
  max-width: 480px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.editorInputs input,
.editorInputs textarea {
  width: 100%;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(15, 23, 42, 0.9);
  padding: 10px 12px;
  color: var(--text);
  font-size: 15px;
}

.editorInputs textarea {
  height: 160px;
  resize: none;
}

/* Palette */
.paletteRow {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.paletteBtns {
  display: flex;
  gap: 6px;
}

.paletteBtn {
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(15, 23, 42, 0.9);
  color: var(--text-soft);
  font-size: 12px;
  cursor: pointer;
}

#colorRow {
  display: flex;
  gap: 8px;
}

.colorDot {
  width: 22px;
  height: 22px;
  border-radius: 999px;
  cursor: pointer;
  border: 2px solid transparent;
}

.colorDot.selected {
  border-color: #fff;
}

/* Pulsanti editor */
.editorActions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.btnDanger {
  background: var(--danger);
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 10px;
  cursor: pointer;
}

.btnGhost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-soft);
  padding: 8px 14px;
  border-radius: 10px;
  cursor: pointer;
}

.btnPrimary {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 10px;
  cursor: pointer;
}

/* ============================================================
   PANNELLO IMPOSTAZIONI
   ============================================================ */
#settingsPanel {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.settingsCard {
  width: 100%;
  max-width: 480px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.settingsHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.settingsTitle {
  font-size: 18px;
  font-weight: 600;
}

.settingsClose {
  cursor: pointer;
  font-size: 18px;
  color: var(--text-soft);
}

.settingsList {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.settingsItem {
  display: flex;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(15, 23, 42, 0.9);
  cursor: pointer;
}

.settingsDanger {
  border-color: var(--danger);
  color: var(--danger);
}

/* ============================================================
   POPUP ARCHIVIO + RESET
   ============================================================ */
#archivePopup,
#resetPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.popupCard {
  width: 100%;
  max-width: 480px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.popupHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.popupClose {
  cursor: pointer;
  font-size: 18px;
  color: var(--text-soft);
}

.popupActions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* ============================================================
   BANNER
   ============================================================ */
#bannerMsg {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--accent);
  color: #fff;
  padding: 10px 18px;
  border-radius: 12px;
  font-size: 14px;
  opacity: 0;
  transition: 0.4s ease;
}

#bannerMsg.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ============================================================
   PIN OVERLAY
   ============================================================ */
#pinOverlay {
  position: fixed;
  inset: 0;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pinCard {
  width: 260px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.pinTitle {
  font-size: 20px;
  font-weight: 600;
  text-align: center;
}

.pinCircles {
  display: flex;
  justify-content: center;
  gap: 10px;
}

.pinCircle {
  width: 14px;
  height: 14px;
  border-radius: 999px;
  border: 2px solid var(--text-soft);
}

.pinCircle.filled {
  background: var(--accent);
  border-color: var(--accent);
}

.pinError {
  text-align: center;
  color: var(--danger);
  font-size: 13px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.pinPad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.pinKey,
#pinBackspace {
  padding: 12px 0;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(15, 23, 42, 0.9);
  color: var(--text);
  font-size: 18px;
  cursor: pointer;
}
/* ============================================================
   PIN SYSTEM
   ============================================================ */
let savedPIN = localStorage.getItem("appPIN") || "4618";
let enteredPIN = "";

const pinOverlay = document.getElementById("pinOverlay");
const pinCircles = document.querySelectorAll(".pinCircle");
const pinError = document.getElementById("pinError");

function updatePinCircles() {
  pinCircles.forEach((c, i) => c.classList.toggle("filled", i < enteredPIN.length));
}

function checkPIN() {
  if (enteredPIN === savedPIN) {
    pinOverlay.style.display = "none";
  } else {
    pinError.textContent = "PIN errato";
    pinError.style.opacity = 1;
    setTimeout(() => pinError.style.opacity = 0, 900);
  }
  enteredPIN = "";
  updatePinCircles();
}

document.querySelectorAll(".pinKey").forEach(btn => {
  btn.onclick = () => {
    const d = btn.dataset.digit;
    if (!d) return;
    if (enteredPIN.length < 4) {
      enteredPIN += d;
      updatePinCircles();
      if (enteredPIN.length === 4) checkPIN();
    }
  };
});

document.getElementById("pinBackspace").onclick = () => {
  enteredPIN = enteredPIN.slice(0, -1);
  updatePinCircles();
};

/* ============================================================
   TRADUZIONI
   ============================================================ */
const translations = {
  it: {
    title: "Note",
    premium: "Premium",
    newNote: "Nuova nota",
    save: "Salva",
    cancel: "Annulla",
    delete: "Elimina",
    archive: "Archivio",
    reset: "Reset app",
    theme: "Tema",
    amoled: "AMOLED",
    font: "Font",
    textSize: "Dimensione testo",
    accent: "Colore accento",
    blur: "Sfocatura",
    animations: "Animazioni",
    haptics: "Haptics",
    export: "Esporta",
    import: "Importa",
    changePin: "Cambia PIN"
  },
  de: {
    title: "Notizen",
    premium: "Premium",
    newNote: "Neue Notiz",
    save: "Speichern",
    cancel: "Abbrechen",
    delete: "L√∂schen",
    archive: "Archiv",
    reset: "App zur√ºcksetzen",
    theme: "Thema",
    amoled: "AMOLED",
    font: "Schriftart",
    textSize: "Textgr√∂√üe",
    accent: "Akzentfarbe",
    blur: "Hintergrund‚ÄëBlur",
    animations: "Animationen",
    haptics: "Haptik",
    export: "Exportieren",
    import: "Importieren",
    changePin: "PIN √§ndern"
  },
  en: {
    title: "Notes",
    premium: "Premium",
    newNote: "New Note",
    save: "Save",
    cancel: "Cancel",
    delete: "Delete",
    archive: "Archive",
    reset: "Reset App",
    theme: "Theme",
    amoled: "AMOLED",
    font: "Font",
    textSize: "Text Size",
    accent: "Accent Color",
    blur: "Background Blur",
    animations: "Animations",
    haptics: "Haptics",
    export: "Export",
    import: "Import",
    changePin: "Change PIN"
  }
};

let currentLang = localStorage.getItem("appLang") || "it";

function applyTranslations() {
  const t = translations[currentLang];

  document.querySelector("#appTitle").childNodes[0].textContent = t.title;
  document.querySelector("#appTitle .sub").textContent = t.premium;

  document.getElementById("editorTitle").textContent = t.newNote;
  document.getElementById("saveBtn").textContent = t.save;
  document.getElementById("cancelBtn").textContent = t.cancel;
  document.getElementById("deleteNoteBtn").textContent = "üóë " + t.delete;

  document.getElementById("settingsTheme").querySelector(".label").textContent = t.theme;
  document.getElementById("settingsAmoled").querySelector(".label").textContent = t.amoled;
  document.getElementById("settingsFont").querySelector(".label").textContent = t.font;
  document.getElementById("settingsTextSize").querySelector(".label").textContent = t.textSize;
  document.getElementById("settingsAccent").querySelector(".label").textContent = t.accent;
  document.getElementById("settingsBlur").querySelector(".label").textContent = t.blur;
  document.getElementById("settingsAnimations").querySelector(".label").textContent = t.animations;
  document.getElementById("settingsHaptics").querySelector(".label").textContent = t.haptics;
  document.getElementById("settingsExport").querySelector(".label").textContent = t.export;
  document.getElementById("settingsImport").querySelector(".label").textContent = t.import;
  document.getElementById("settingsArchive").querySelector(".label").textContent = t.archive;
  document.getElementById("settingsResetApp").querySelector(".label").textContent = t.reset;
}

document.getElementById("langBtn").onclick = () => {
  currentLang = currentLang === "it" ? "de" : currentLang === "de" ? "en" : "it";
  localStorage.setItem("appLang", currentLang);
  applyTranslations();
};

/* ============================================================
   TEMA + AMOLED
   ============================================================ */
let theme = localStorage.getItem("theme") || "light";
let amoled = localStorage.getItem("amoled") === "true";

function applyTheme() {
  document.body.classList.remove("dark", "amoled");
  if (amoled) document.body.classList.add("amoled");
  else if (theme === "dark") document.body.classList.add("dark");
}

document.getElementById("themeBtn").onclick = () => {
  theme = theme === "light" ? "dark" : "light";
  localStorage.setItem("theme", theme);
  applyTheme();
};

document.getElementById("settingsAmoled").onclick = () => {
  amoled = !amoled;
  localStorage.setItem("amoled", amoled);
  applyTheme();
};

/* ============================================================
   BACKUP MANUALE (üõü)
   ============================================================ */
document.getElementById("backupBtn").onclick = () => {
  const data = {
    notes,
    archive,
    pin: savedPIN,
    lang: currentLang,
    theme,
    amoled
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "backup.json";
  a.click();

  URL.revokeObjectURL(url);
  showBanner("Backup salvato");
};
/* ============================================================
   NOTE SYSTEM
   ============================================================ */
let notes = JSON.parse(localStorage.getItem("notes") || "[]");
let archive = JSON.parse(localStorage.getItem("archive") || "[]");

let editingNoteId = null;
let selectedColor = "#4f8cff";

const palettes = {
  warm: ["#ff6b6b", "#ff9f43", "#ffa502", "#ff4757", "#eccc68"],
  cool: ["#1e90ff", "#3742fa", "#2ed573", "#70a1ff", "#5352ed"],
  pastel: ["#ffcccc", "#ffd3b6", "#dcedc1", "#a8e6cf", "#d4a5a5"],
  mix: ["#ff6b6b", "#1e90ff", "#2ed573", "#ffa502", "#a55eea"]
};

/* ============================================================
   PALETTE COLORI
   ============================================================ */
function loadPalette(p) {
  const row = document.getElementById("colorRow");
  row.innerHTML = "";
  palettes[p].forEach(c => {
    const dot = document.createElement("div");
    dot.className = "colorDot";
    dot.style.background = c;
    dot.onclick = () => {
      selectedColor = c;
      document.querySelectorAll(".colorDot").forEach(d => d.classList.remove("selected"));
      dot.classList.add("selected");
    };
    row.appendChild(dot);
  });
}

document.querySelectorAll(".paletteBtn").forEach(btn => {
  btn.onclick = () => loadPalette(btn.dataset.pal);
});

/* ============================================================
   RENDER NOTE
   ============================================================ */
function renderNotes() {
  const list = document.getElementById("notesList");
  list.innerHTML = "";

  const activeCat = document.querySelector(".cat.active").dataset.cat;

  notes.forEach(n => {
    if (activeCat !== "all" && n.category !== activeCat) return;

    const item = document.createElement("div");
    item.className = "noteItem";
    item.style.borderLeftColor = n.color;
    item.innerHTML = `
      <div class="noteTitleRow">
        <div class="noteTitle">${n.title || "Senza titolo"}</div>
        <div class="noteMeta">${n.date}</div>
      </div>
      <div class="noteTextPreview">${n.text.slice(0, 120)}</div>
    `;
    item.onclick = () => openEditor(n.id);
    list.appendChild(item);
  });
}

/* ============================================================
   CATEGORIE
   ============================================================ */
document.querySelectorAll(".cat").forEach(cat => {
  cat.onclick = () => {
    document.querySelectorAll(".cat").forEach(c => c.classList.remove("active"));
    cat.classList.add("active");
    renderNotes();
  };
});

/* ============================================================
   EDITOR NOTE
   ============================================================ */
function openEditor(id = null) {
  editingNoteId = id;

  if (id) {
    const n = notes.find(x => x.id === id);
    document.getElementById("noteTitleInput").value = n.title;
    document.getElementById("noteText").value = n.text;
    selectedColor = n.color;
  } else {
    document.getElementById("noteTitleInput").value = "";
    document.getElementById("noteText").value = "";
    selectedColor = "#4f8cff";
  }

  loadPalette("mix");
  document.getElementById("noteEditor").style.display = "flex";
}

document.getElementById("addNoteBtn").onclick = () => openEditor(null);

/* ============================================================
   SALVA NOTA
   ============================================================ */
document.getElementById("saveBtn").onclick = () => {
  const title = document.getElementById("noteTitleInput").value.trim();
  const text = document.getElementById("noteText").value.trim();

  if (!text) return showBanner("Nota vuota");

  if (editingNoteId) {
    const n = notes.find(x => x.id === editingNoteId);
    n.title = title;
    n.text = text;
    n.color = selectedColor;
    n.date = new Date().toLocaleDateString();
  } else {
    const cat = document.querySelector(".cat.active").dataset.cat;
    notes.push({
      id: Date.now(),
      title,
      text,
      color: selectedColor,
      category: cat,
      date: new Date().toLocaleDateString()
    });
  }

  localStorage.setItem("notes", JSON.stringify(notes));
  document.getElementById("noteEditor").style.display = "none";
  renderNotes();
};

/* ============================================================
   ELIMINA (ARCHIVIA) NOTA
   ============================================================ */
document.getElementById("deleteNoteBtn").onclick = () => {
  if (!editingNoteId) return;
  const n = notes.find(x => x.id === editingNoteId);
  archive.push(n);
  notes = notes.filter(x => x.id !== editingNoteId);

  localStorage.setItem("notes", JSON.stringify(notes));
  localStorage.setItem("archive", JSON.stringify(archive));

  document.getElementById("noteEditor").style.display = "none";
  renderNotes();
};

/* ============================================================
   ANNULLA EDITOR
   ============================================================ */
document.getElementById("cancelBtn").onclick = () => {
  document.getElementById("noteEditor").style.display = "none";
};

/* ============================================================
   ARCHIVIO
   ============================================================ */
document.getElementById("settingsArchive").onclick = () => {
  const list = document.getElementById("archiveList");
  list.innerHTML = "";
  archive.forEach(n => {
    const div = document.createElement("div");
    div.innerHTML = `<b>${n.title}</b><br>${n.text.slice(0, 100)}...`;
    div.style.marginBottom = "10px";
    list.appendChild(div);
  });
  document.getElementById("archivePopup").style.display = "flex";
};

document.getElementById("archiveCloseBtn").onclick = () => {
  document.getElementById("archivePopup").style.display = "none";
};

/* ============================================================
   BANNER
   ============================================================ */
function showBanner(msg) {
  const b = document.getElementById("bannerMsg");
  b.textContent = msg;
  b.classList.add("show");
  setTimeout(() => b.classList.remove("show"), 1500);
}
/* ============================================================
   IMPORT JSON
   ============================================================ */
document.getElementById("settingsImport").onclick = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);

        notes = data.notes || [];
        archive = data.archive || [];
        savedPIN = data.pin || "4618";
        currentLang = data.lang || "it";
        theme = data.theme || "light";
        amoled = data.amoled || false;

        localStorage.setItem("notes", JSON.stringify(notes));
        localStorage.setItem("archive", JSON.stringify(archive));
        localStorage.setItem("appPIN", savedPIN);
        localStorage.setItem("appLang", currentLang);
        localStorage.setItem("theme", theme);
        localStorage.setItem("amoled", amoled);

        applyTranslations();
        applyTheme();
        renderNotes();

        showBanner("Import riuscito");
      } catch {
        showBanner("Errore import");
      }
    };

    reader.readAsText(file);
  };

  input.click();
};

/* ============================================================
   RESET APP
   ============================================================ */
document.getElementById("settingsResetApp").onclick = () => {
  document.getElementById("resetPopup").style.display = "flex";
};

document.getElementById("resetCancelBtn").onclick = () => {
  document.getElementById("resetPopup").style.display = "none";
};

document.getElementById("resetConfirmBtn").onclick = () => {
  localStorage.clear();

  notes = [];
  archive = [];
  savedPIN = "4618";
  currentLang = "it";
  theme = "light";
  amoled = false;

  applyTranslations();
  applyTheme();
  renderNotes();

  document.getElementById("resetPopup").style.display = "none";
  showBanner("Reset completato");
};

/* ============================================================
   IMPOSTAZIONI AVANZATE
   ============================================================ */

/* FONT */
let currentFont = localStorage.getItem("font") || "-apple-system";

function applyFont() {
  document.body.style.fontFamily = currentFont;
}

document.getElementById("settingsFont").onclick = () => {
  const fonts = ["-apple-system", "Helvetica Neue", "Arial", "Georgia", "Courier New"];
  currentFont = fonts[(fonts.indexOf(currentFont) + 1) % fonts.length];
  localStorage.setItem("font", currentFont);
  applyFont();
  showBanner("Font cambiato");
};

/* DIMENSIONE TESTO */
let textSize = parseInt(localStorage.getItem("textSize") || "16");

function applyTextSize() {
  document.body.style.fontSize = textSize + "px";
}

document.getElementById("settingsTextSize").onclick = () => {
  textSize = textSize >= 22 ? 14 : textSize + 1;
  localStorage.setItem("textSize", textSize);
  applyTextSize();
  showBanner("Dimensione: " + textSize);
};

/* COLORE ACCENTO */
let accentColors = ["#4f8cff", "#ff3b30", "#ff9500", "#34c759", "#5856d6"];
let accentIndex = parseInt(localStorage.getItem("accentIndex") || "0");

function applyAccent() {
  document.documentElement.style.setProperty("--accent", accentColors[accentIndex]);
  document.documentElement.style.setProperty("--accent-light", accentColors[accentIndex] + "55");
  document.documentElement.style.setProperty("--accent-glow", accentColors[accentIndex] + "55");
}

document.getElementById("settingsAccent").onclick = () => {
  accentIndex = (accentIndex + 1) % accentColors.length;
  localStorage.setItem("accentIndex", accentIndex);
  applyAccent();
  showBanner("Colore cambiato");
};

/* BLUR */
let blurAmount = parseInt(localStorage.getItem("blur") || "18");

function applyBlur() {
  document.documentElement.style.setProperty("--blur-amount", blurAmount + "px");
}

document.getElementById("settingsBlur").onclick = () => {
  blurAmount = blurAmount >= 30 ? 6 : blurAmount + 2;
  localStorage.setItem("blur", blurAmount);
  applyBlur();
  showBanner("Blur: " + blurAmount);
};

/* ANIMAZIONI */
let animationsEnabled = localStorage.getItem("animations") !== "false";

function applyAnimations() {
  document.body.style.setProperty("--anim", animationsEnabled ? "1" : "0");
}

document.getElementById("settingsAnimations").onclick = () => {
  animationsEnabled = !animationsEnabled;
  localStorage.setItem("animations", animationsEnabled);
  applyAnimations();
  showBanner(animationsEnabled ? "Animazioni ON" : "Animazioni OFF");
};

/* HAPTICS (placeholder, iOS Safari non supporta nativamente) */
let hapticsEnabled = localStorage.getItem("haptics") !== "false";

document.getElementById("settingsHaptics").onclick = () => {
  hapticsEnabled = !hapticsEnabled;
  localStorage.setItem("haptics", hapticsEnabled);
  showBanner(hapticsEnabled ? "Haptics ON" : "Haptics OFF");
};

/* ============================================================
   INIZIALIZZAZIONE FINALE
   ============================================================ */
applyTranslations();
applyTheme();
applyFont();
applyTextSize();
applyAccent();
applyBlur();
applyAnimations();
renderNotes();
/* ============================================================
   NOTE + ARCHIVIO (prima, cos√¨ esistono per backupBtn)
   ============================================================ */
let notes = JSON.parse(localStorage.getItem("notes") || "[]");
let archive = JSON.parse(localStorage.getItem("archive") || "[]");

/* ============================================================
   PIN SYSTEM
   ============================================================ */
let savedPIN = localStorage.getItem("appPIN") || "4618";
let enteredPIN = "";

const pinOverlay = document.getElementById("pinOverlay");
const pinCircles = document.querySelectorAll(".pinCircle");
const pinError = document.getElementById("pinError");

function updatePinCircles() {
  pinCircles.forEach((c, i) => c.classList.toggle("filled", i < enteredPIN.length));
}

function checkPIN() {
  if (enteredPIN === savedPIN) {
    pinOverlay.style.display = "none";
  } else {
    pinError.textContent = "PIN errato";
    pinError.style.opacity = 1;
    setTimeout(() => pinError.style.opacity = 0, 900);
  }
  enteredPIN = "";
  updatePinCircles();
}

document.querySelectorAll(".pinKey").forEach(btn => {
  btn.onclick = () => {
    const d = btn.dataset.digit;
    if (!d) return;
    if (enteredPIN.length < 4) {
      enteredPIN += d;
      updatePinCircles();
      if (enteredPIN.length === 4) checkPIN();
    }
  };
});

document.getElementById("pinBackspace").onclick = () => {
  enteredPIN = enteredPIN.slice(0, -1);
  updatePinCircles();
};

/* ============================================================
   TRADUZIONI
   ============================================================ */
const translations = {
  it: {
    title: "Note",
    premium: "Premium",
    newNote: "Nuova nota",
    save: "Salva",
    cancel: "Annulla",
    delete: "Elimina",
    archive: "Archivio",
    reset: "Reset app",
    theme: "Tema",
    amoled: "AMOLED",
    font: "Font",
    textSize: "Dimensione testo",
    accent: "Colore accento",
    blur: "Sfocatura",
    animations: "Animazioni",
    haptics: "Haptics",
    export: "Esporta",
    import: "Importa",
    changePin: "Cambia PIN"
  },
  de: {
    title: "Notizen",
    premium: "Premium",
    newNote: "Neue Notiz",
    save: "Speichern",
    cancel: "Abbrechen",
    delete: "L√∂schen",
    archive: "Archiv",
    reset: "App zur√ºcksetzen",
    theme: "Thema",
    amoled: "AMOLED",
    font: "Schriftart",
    textSize: "Textgr√∂√üe",
    accent: "Akzentfarbe",
    blur: "Hintergrund‚ÄëBlur",
    animations: "Animationen",
    haptics: "Haptik",
    export: "Exportieren",
    import: "Importieren",
    changePin: "PIN √§ndern"
  },
  en: {
    title: "Notes",
    premium: "Premium",
    newNote: "New Note",
    save: "Save",
    cancel: "Cancel",
    delete: "Delete",
    archive: "Archive",
    reset: "Reset App",
    theme: "Theme",
    amoled: "AMOLED",
    font: "Font",
    textSize: "Text Size",
    accent: "Accent Color",
    blur: "Background Blur",
    animations: "Animations",
    haptics: "Haptics",
    export: "Export",
    import: "Import",
    changePin: "Change PIN"
  }
};

let currentLang = localStorage.getItem("appLang") || "it";

function applyTranslations() {
  const t = translations[currentLang];

  const appTitle = document.querySelector("#appTitle");
  if (appTitle) {
    appTitle.childNodes[0].textContent = t.title;
    appTitle.querySelector(".sub").textContent = t.premium;
  }

  const editorTitle = document.getElementById("editorTitle");
  if (editorTitle) editorTitle.textContent = t.newNote;

  const saveBtn = document.getElementById("saveBtn");
  if (saveBtn) saveBtn.textContent = t.save;

  const cancelBtn = document.getElementById("cancelBtn");
  if (cancelBtn) cancelBtn.textContent = t.cancel;

  const deleteNoteBtn = document.getElementById("deleteNoteBtn");
  if (deleteNoteBtn) deleteNoteBtn.textContent = "üóë " + t.delete;

  const map = [
    ["settingsTheme", "theme"],
    ["settingsAmoled", "amoled"],
    ["settingsFont", "font"],
    ["settingsTextSize", "textSize"],
    ["settingsAccent", "accent"],
    ["settingsBlur", "blur"],
    ["settingsAnimations", "animations"],
    ["settingsHaptics", "haptics"],
    ["settingsExport", "export"],
    ["settingsImport", "import"],
    ["settingsArchive", "archive"],
    ["settingsResetApp", "reset"]
  ];

  map.forEach(([id, key]) => {
    const el = document.getElementById(id);
    if (el) el.querySelector(".label").textContent = t[key];
  });
}

document.getElementById("langBtn").onclick = () => {
  currentLang = currentLang === "it" ? "de" : currentLang === "de" ? "en" : "it";
  localStorage.setItem("appLang", currentLang);
  applyTranslations();
};

/* ============================================================
   TEMA + AMOLED
   ============================================================ */
let theme = localStorage.getItem("theme") || "light";
let amoled = localStorage.getItem("amoled") === "true";

function applyTheme() {
  document.body.classList.remove("dark", "amoled");
  if (amoled) document.body.classList.add("amoled");
  else if (theme === "dark") document.body.classList.add("dark");
}

document.getElementById("themeBtn").onclick = () => {
  theme = theme === "light" ? "dark" : "light";
  localStorage.setItem("theme", theme);
  applyTheme();
};

document.getElementById("settingsAmoled").onclick = () => {
  amoled = !amoled;
  localStorage.setItem("amoled", amoled);
  applyTheme();
};

/* ============================================================
   BACKUP MANUALE (üõü)
   ============================================================ */
document.getElementById("backupBtn").onclick = () => {
  const data = {
    notes,
    archive,
    pin: savedPIN,
    lang: currentLang,
    theme,
    amoled
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "backup.json";
  a.click();
  URL.revokeObjectURL(url);
  showBanner("Backup salvato");
};

/* ============================================================
   PALETTE COLORI
   ============================================================ */
let editingNoteId = null;
let selectedColor = "#4f8cff";

const palettes = {
  warm: ["#ff6b6b", "#ff9f43", "#ffa502", "#ff4757", "#eccc68"],
  cool: ["#1e90ff", "#3742fa", "#2ed573", "#70a1ff", "#5352ed"],
  pastel: ["#ffcccc", "#ffd3b6", "#dcedc1", "#a8e6cf", "#d4a5a5"],
  mix: ["#ff6b6b", "#1e90ff", "#2ed573", "#ffa502", "#a55eea"]
};

function loadPalette(p) {
  const row = document.getElementById("colorRow");
  if (!row) return;
  row.innerHTML = "";
  palettes[p].forEach(c => {
    const dot = document.createElement("div");
    dot.className = "colorDot";
    dot.style.background = c;
    dot.onclick = () => {
      selectedColor = c;
      document.querySelectorAll(".colorDot").forEach(d => d.classList.remove("selected"));
      dot.classList.add("selected");
    };
    row.appendChild(dot);
  });
}

document.querySelectorAll(".paletteBtn").forEach(btn => {
  btn.onclick = () => loadPalette(btn.dataset.pal);
});

/* ============================================================
   RENDER NOTE
   ============================================================ */
function renderNotes() {
  const list = document.getElementById("notesList");
  if (!list) return;
  list.innerHTML = "";

  const activeCatEl = document.querySelector(".cat.active");
  const activeCat = activeCatEl ? activeCatEl.dataset.cat : "all";

  notes.forEach(n => {
    if (activeCat !== "all" && n.category !== activeCat) return;

    const item = document.createElement("div");
    item.className = "noteItem";
    item.style.borderLeftColor = n.color;
    item.innerHTML = `
      <div class="noteTitleRow">
        <div class="noteTitle">${n.title || "Senza titolo"}</div>
        <div class="noteMeta">${n.date}</div>
      </div>
      <div class="noteTextPreview">${n.text.slice(0, 120)}</div>
    `;
    item.onclick = () => openEditor(n.id);
    list.appendChild(item);
  });
}

/* ============================================================
   CATEGORIE
   ============================================================ */
document.querySelectorAll(".cat").forEach(cat => {
  cat.onclick = () => {
    document.querySelectorAll(".cat").forEach(c => c.classList.remove("active"));
    cat.classList.add("active");
    renderNotes();
  };
});

/* ============================================================
   EDITOR NOTE
   ============================================================ */
function openEditor(id = null) {
  editingNoteId = id;

  const titleInput = document.getElementById("noteTitleInput");
  const textInput = document.getElementById("noteText");
  const editor = document.getElementById("noteEditor");

  if (!titleInput || !textInput || !editor) return;

  if (id) {
    const n = notes.find(x => x.id === id);
    if (!n) return;
    titleInput.value = n.title;
    textInput.value = n.text;
    selectedColor = n.color;
  } else {
    titleInput.value = "";
    textInput.value = "";
    selectedColor = "#4f8cff";
  }

  loadPalette("mix");
  editor.style.display = "flex";
}

document.getElementById("addNoteBtn").onclick = () => openEditor(null);

/* ============================================================
   SALVA NOTA
   ============================================================ */
document.getElementById("saveBtn").onclick = () => {
  const title = document.getElementById("noteTitleInput").value.trim();
  const text = document.getElementById("noteText").value.trim();

  if (!text) return showBanner("Nota vuota");

  if (editingNoteId) {
    const n = notes.find(x => x.id === editingNoteId);
    if (!n) return;
    n.title = title;
    n.text = text;
    n.color = selectedColor;
    n.date = new Date().toLocaleDateString();
  } else {
    const activeCatEl = document.querySelector(".cat.active");
    const cat = activeCatEl ? activeCatEl.dataset.cat : "all";
    notes.push({
      id: Date.now(),
      title,
      text,
      color: selectedColor,
      category: cat,
      date: new Date().toLocaleDateString()
    });
  }

  localStorage.setItem("notes", JSON.stringify(notes));
  document.getElementById("noteEditor").style.display = "none";
  renderNotes();
};

/* ============================================================
   ELIMINA (ARCHIVIA) NOTA
   ============================================================ */
document.getElementById("deleteNoteBtn").onclick = () => {
  if (!editingNoteId) return;
  const n = notes.find(x => x.id === editingNoteId);
  if (!n) return;

  archive.push(n);
  notes = notes.filter(x => x.id !== editingNoteId);

  localStorage.setItem("notes", JSON.stringify(notes));
  localStorage.setItem("archive", JSON.stringify(archive));

  document.getElementById("noteEditor").style.display = "none";
  renderNotes();
};

/* ============================================================
   ANNULLA EDITOR
   ============================================================ */
document.getElementById("cancelBtn").onclick = () => {
  document.getElementById("noteEditor").style.display = "none";
};

/* ============================================================
   ARCHIVIO
   ============================================================ */
document.getElementById("settingsArchive").onclick = () => {
  const list = document.getElementById("archiveList");
  if (!list) return;
  list.innerHTML = "";
  archive.forEach(n => {
    const div = document.createElement("div");
    div.innerHTML = `<b>${n.title}</b><br>${n.text.slice(0, 100)}...`;
    div.style.marginBottom = "10px";
    list.appendChild(div);
  });
  document.getElementById("archivePopup").style.display = "flex";
};

document.getElementById("archiveCloseBtn").onclick = () => {
  document.getElementById("archivePopup").style.display = "none";
};

/* ============================================================
   BANNER
   ============================================================ */
function showBanner(msg) {
  const b = document.getElementById("bannerMsg");
  if (!b) return;
  b.textContent = msg;
  b.classList.add("show");
  setTimeout(() => b.classList.remove("show"), 1500);
}

/* ============================================================
   IMPORT JSON
   ============================================================ */
document.getElementById("settingsImport").onclick = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);

        notes = data.notes || [];
        archive = data.archive || [];
        savedPIN = data.pin || "4618";
        currentLang = data.lang || "it";
        theme = data.theme || "light";
        amoled = data.amoled || false;

        localStorage.setItem("notes", JSON.stringify(notes));
        localStorage.setItem("archive", JSON.stringify(archive));
        localStorage.setItem("appPIN", savedPIN);
        localStorage.setItem("appLang", currentLang);
        localStorage.setItem("theme", theme);
        localStorage.setItem("amoled", amoled);

        applyTranslations();
        applyTheme();
        renderNotes();

        showBanner("Import riuscito");
      } catch {
        showBanner("Errore import");
      }
    };

    reader.readAsText(file);
  };

  input.click();
};

/* ============================================================
   RESET APP
   ============================================================ */
document.getElementById("settingsResetApp").onclick = () => {
  document.getElementById("resetPopup").style.display = "flex";
};

document.getElementById("resetCancelBtn").onclick = () => {
  document.getElementById("resetPopup").style.display = "none";
};

document.getElementById("resetConfirmBtn").onclick = () => {
  localStorage.clear();

  notes = [];
  archive = [];
  savedPIN = "4618";
  currentLang = "it";
  theme = "light";
  amoled = false;

  applyTranslations();
  applyTheme();
  renderNotes();

  document.getElementById("resetPopup").style.display = "none";
  showBanner("Reset completato");
};

/* ============================================================
   IMPOSTAZIONI AVANZATE
   ============================================================ */

/* FONT */
let currentFont = localStorage.getItem("font") || "-apple-system";

function applyFont() {
  document.body.style.fontFamily = currentFont;
}

document.getElementById("settingsFont").onclick = () => {
  const fonts = ["-apple-system", "Helvetica Neue", "Arial", "Georgia", "Courier New"];
  currentFont = fonts[(fonts.indexOf(currentFont) + 1) % fonts.length];
  localStorage.setItem("font", currentFont);
  applyFont();
  showBanner("Font cambiato");
};

/* DIMENSIONE TESTO */
let textSize = parseInt(localStorage.getItem("textSize") || "16");

function applyTextSize() {
  document.body.style.fontSize = textSize + "px";
}

document.getElementById("settingsTextSize").onclick = () => {
  textSize = textSize >= 22 ? 14 : textSize + 1;
  localStorage.setItem("textSize", textSize);
  applyTextSize();
  showBanner("Dimensione: " + textSize);
};

/* COLORE ACCENTO */
let accentColors = ["#4f8cff", "#ff3b30", "#ff9500", "#34c759", "#5856d6"];
let accentIndex = parseInt(localStorage.getItem("accentIndex") || "0");

function applyAccent() {
  document.documentElement.style.setProperty("--accent", accentColors[accentIndex]);
  document.documentElement.style.setProperty("--accent-light", accentColors[accentIndex] + "55");
  document.documentElement.style.setProperty("--accent-glow", accentColors[accentIndex] + "55");
}

document.getElementById("settingsAccent").onclick = () => {
  accentIndex = (accentIndex + 1) % accentColors.length;
  localStorage.setItem("accentIndex", accentIndex);
  applyAccent();
  showBanner("Colore cambiato");
};

/* BLUR */
let blurAmount = parseInt(localStorage.getItem("blur") || "18");

function applyBlur() {
  document.documentElement.style.setProperty("--blur-amount", blurAmount + "px");
}

document.getElementById("settingsBlur").onclick = () => {
  blurAmount = blurAmount >= 30 ? 6 : blurAmount + 2;
  localStorage.setItem("blur", blurAmount);
  applyBlur();
  showBanner("Blur: " + blurAmount);
};

/* ANIMAZIONI */
let animationsEnabled = localStorage.getItem("animations") !== "false";

function applyAnimations() {
  document.body.style.setProperty("--anim", animationsEnabled ? "1" : "0");
}

document.getElementById("settingsAnimations").onclick = () => {
  animationsEnabled = !animationsEnabled;
  localStorage.setItem("animations", animationsEnabled);
  applyAnimations();
  showBanner(animationsEnabled ? "Animazioni ON" : "Animazioni OFF");
};

/* HAPTICS (placeholder) */
let hapticsEnabled = localStorage.getItem("haptics") !== "false";

document.getElementById("settingsHaptics").onclick = () => {
  hapticsEnabled = !hapticsEnabled;
  localStorage.setItem("haptics", hapticsEnabled);
  showBanner(hapticsEnabled ? "Haptics ON" : "Haptics OFF");
};

/* ============================================================
   PANNELLO IMPOSTAZIONI (‚öôÔ∏è)
   ============================================================ */
document.getElementById("settingsBtn").onclick = () => {
  document.getElementById("settingsPanel").style.display = "flex";
};

document.querySelector("#settingsPanel .settingsClose").onclick = () => {
  document.getElementById("settingsPanel").style.display = "none";
};

/* ============================================================
   INIZIALIZZAZIONE FINALE
   ============================================================ */
applyTranslations();
applyTheme();
applyFont();
applyTextSize();
applyAccent();
applyBlur();
applyAnimations();
renderNotes();
   /* ============================================================
   NOTE + ARCHIVIO (prima, cos√¨ esistono per backupBtn)
   ============================================================ */
let notes = JSON.parse(localStorage.getItem("notes") || "[]");
let archive = JSON.parse(localStorage.getItem("archive") || "[]");

/* ============================================================
   PIN SYSTEM
   ============================================================ */
let savedPIN = localStorage.getItem("appPIN") || "4618";
let enteredPIN = "";

const pinOverlay = document.getElementById("pinOverlay");
const pinCircles = document.querySelectorAll(".pinCircle");
const pinError = document.getElementById("pinError");

function updatePinCircles() {
  pinCircles.forEach((c, i) => c.classList.toggle("filled", i < enteredPIN.length));
}

function checkPIN() {
  if (enteredPIN === savedPIN) {
    pinOverlay.style.display = "none";
  } else {
    pinError.textContent = "PIN errato";
    pinError.style.opacity = 1;
    setTimeout(() => pinError.style.opacity = 0, 900);
  }
  enteredPIN = "";
  updatePinCircles();
}

document.querySelectorAll(".pinKey").forEach(btn => {
  btn.onclick = () => {
    const d = btn.dataset.digit;
    if (!d) return;
    if (enteredPIN.length < 4) {
      enteredPIN += d;
      updatePinCircles();
      if (enteredPIN.length === 4) checkPIN();
    }
  };
});

document.getElementById("pinBackspace").onclick = () => {
  enteredPIN = enteredPIN.slice(0, -1);
  updatePinCircles();
};

/* ============================================================
   TRADUZIONI
   ============================================================ */
const translations = {
  it: {
    title: "Note",
    premium: "Premium",
    newNote: "Nuova nota",
    save: "Salva",
    cancel: "Annulla",
    delete: "Elimina",
    archive: "Archivio",
    reset: "Reset app",
    theme: "Tema",
    amoled: "AMOLED",
    font: "Font",
    textSize: "Dimensione testo",
    accent: "Colore accento",
    blur: "Sfocatura",
    animations: "Animazioni",
    haptics: "Haptics",
    export: "Esporta",
    import: "Importa",
    changePin: "Cambia PIN"
  },
  de: {
    title: "Notizen",
    premium: "Premium",
    newNote: "Neue Notiz",
    save: "Speichern",
    cancel: "Abbrechen",
    delete: "L√∂schen",
    archive: "Archiv",
    reset: "App zur√ºcksetzen",
    theme: "Thema",
    amoled: "AMOLED",
    font: "Schriftart",
    textSize: "Textgr√∂√üe",
    accent: "Akzentfarbe",
    blur: "Hintergrund‚ÄëBlur",
    animations: "Animationen",
    haptics: "Haptik",
    export: "Exportieren",
    import: "Importieren",
    changePin: "PIN √§ndern"
  },
  en: {
    title: "Notes",
    premium: "Premium",
    newNote: "New Note",
    save: "Save",
    cancel: "Cancel",
    delete: "Delete",
    archive: "Archive",
    reset: "Reset App",
    theme: "Theme",
    amoled: "AMOLED",
    font: "Font",
    textSize: "Text Size",
    accent: "Accent Color",
    blur: "Background Blur",
    animations: "Animations",
    haptics: "Haptics",
    export: "Export",
    import: "Import",
    changePin: "Change PIN"
  }
};

let currentLang = localStorage.getItem("appLang") || "it";

function applyTranslations() {
  const t = translations[currentLang];

  const appTitle = document.querySelector("#appTitle");
  if (appTitle) {
    appTitle.childNodes[0].textContent = t.title;
    appTitle.querySelector(".sub").textContent = t.premium;
  }

  const editorTitle = document.getElementById("editorTitle");
  if (editorTitle) editorTitle.textContent = t.newNote;

  const saveBtn = document.getElementById("saveBtn");
  if (saveBtn) saveBtn.textContent = t.save;

  const cancelBtn = document.getElementById("cancelBtn");
  if (cancelBtn) cancelBtn.textContent = t.cancel;

  const deleteNoteBtn = document.getElementById("deleteNoteBtn");
  if (deleteNoteBtn) deleteNoteBtn.textContent = "üóë " + t.delete;

  const map = [
    ["settingsTheme", "theme"],
    ["settingsAmoled", "amoled"],
    ["settingsFont", "font"],
    ["settingsTextSize", "textSize"],
    ["settingsAccent", "accent"],
    ["settingsBlur", "blur"],
    ["settingsAnimations", "animations"],
    ["settingsHaptics", "haptics"],
    ["settingsExport", "export"],
    ["settingsImport", "import"],
    ["settingsArchive", "archive"],
    ["settingsResetApp", "reset"]
  ];

  map.forEach(([id, key]) => {
    const el = document.getElementById(id);
    if (el) el.querySelector(".label").textContent = t[key];
  });
}

document.getElementById("langBtn").onclick = () => {
  currentLang = currentLang === "it" ? "de" : currentLang === "de" ? "en" : "it";
  localStorage.setItem("appLang", currentLang);
  applyTranslations();
};

/* ============================================================
   TEMA + AMOLED
   ============================================================ */
let theme = localStorage.getItem("theme") || "light";
let amoled = localStorage.getItem("amoled") === "true";

function applyTheme() {
  document.body.classList.remove("dark", "amoled");
  if (amoled) document.body.classList.add("amoled");
  else if (theme === "dark") document.body.classList.add("dark");
}

document.getElementById("themeBtn").onclick = () => {
  theme = theme === "light" ? "dark" : "light";
  localStorage.setItem("theme", theme);
  applyTheme();
};

document.getElementById("settingsAmoled").onclick = () => {
  amoled = !amoled;
  localStorage.setItem("amoled", amoled);
  applyTheme();
};

/* ============================================================
   BACKUP MANUALE (üõü)
   ============================================================ */
document.getElementById("backupBtn").onclick = () => {
  const data = {
    notes,
    archive,
    pin: savedPIN,
    lang: currentLang,
    theme,
    amoled
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "backup.json";
  a.click();
  URL.revokeObjectURL(url);
  showBanner("Backup salvato");
};

/* ============================================================
   PALETTE COLORI
   ============================================================ */
let editingNoteId = null;
let selectedColor = "#4f8cff";

const palettes = {
  warm: ["#ff6b6b", "#ff9f43", "#ffa502", "#ff4757", "#eccc68"],
  cool: ["#1e90ff", "#3742fa", "#2ed573", "#70a1ff", "#5352ed"],
  pastel: ["#ffcccc", "#ffd3b6", "#dcedc1", "#a8e6cf", "#d4a5a5"],
  mix: ["#ff6b6b", "#1e90ff", "#2ed573", "#ffa502", "#a55eea"]
};

function loadPalette(p) {
  const row = document.getElementById("colorRow");
  if (!row) return;
  row.innerHTML = "";
  palettes[p].forEach(c => {
    const dot = document.createElement("div");
    dot.className = "colorDot";
    dot.style.background = c;
    dot.onclick = () => {
      selectedColor = c;
      document.querySelectorAll(".colorDot").forEach(d => d.classList.remove("selected"));
      dot.classList.add("selected");
    };
    row.appendChild(dot);
  });
}

document.querySelectorAll(".paletteBtn").forEach(btn => {
  btn.onclick = () => loadPalette(btn.dataset.pal);
});

/* ============================================================
   RENDER NOTE
   ============================================================ */
function renderNotes() {
  const list = document.getElementById("notesList");
  if (!list) return;
  list.innerHTML = "";

  const activeCatEl = document.querySelector(".cat.active");
  const activeCat = activeCatEl ? activeCatEl.dataset.cat : "all";

  notes.forEach(n => {
    if (activeCat !== "all" && n.category !== activeCat) return;

    const item = document.createElement("div");
    item.className = "noteItem";
    item.style.borderLeftColor = n.color;
    item.innerHTML = `
      <div class="noteTitleRow">
        <div class="noteTitle">${n.title || "Senza titolo"}</div>
        <div class="noteMeta">${n.date}</div>
      </div>
      <div class="noteTextPreview">${n.text.slice(0, 120)}</div>
    `;
    item.onclick = () => openEditor(n.id);
    list.appendChild(item);
  });
}

/* ============================================================
   CATEGORIE
   ============================================================ */
document.querySelectorAll(".cat").forEach(cat => {
  cat.onclick = () => {
    document.querySelectorAll(".cat").forEach(c => c.classList.remove("active"));
    cat.classList.add("active");
    renderNotes();
  };
});

/* ============================================================
   EDITOR NOTE
   ============================================================ */
function openEditor(id = null) {
  editingNoteId = id;

  const titleInput = document.getElementById("noteTitleInput");
  const textInput = document.getElementById("noteText");
  const editor = document.getElementById("noteEditor");

  if (!titleInput || !textInput || !editor) return;

  if (id) {
    const n = notes.find(x => x.id === id);
    if (!n) return;
    titleInput.value = n.title;
    textInput.value = n.text;
    selectedColor = n.color;
  } else {
    titleInput.value = "";
    textInput.value = "";
    selectedColor = "#4f8cff";
  }

  loadPalette("mix");
  editor.style.display = "flex";
}

document.getElementById("addNoteBtn").onclick = () => openEditor(null);

/* ============================================================
   SALVA NOTA
   ============================================================ */
document.getElementById("saveBtn").onclick = () => {
  const title = document.getElementById("noteTitleInput").value.trim();
  const text = document.getElementById("noteText").value.trim();

  if (!text) return showBanner("Nota vuota");

  if (editingNoteId) {
    const n = notes.find(x => x.id === editingNoteId);
    if (!n) return;
    n.title = title;
    n.text = text;
    n.color = selectedColor;
    n.date = new Date().toLocaleDateString();
  } else {
    const activeCatEl = document.querySelector(".cat.active");
    const cat = activeCatEl ? activeCatEl.dataset.cat : "all";
    notes.push({
      id: Date.now(),
      title,
      text,
      color: selectedColor,
      category: cat,
      date: new Date().toLocaleDateString()
    });
  }

  localStorage.setItem("notes", JSON.stringify(notes));
  document.getElementById("noteEditor").style.display = "none";
  renderNotes();
};

/* ============================================================
   ELIMINA (ARCHIVIA) NOTA
   ============================================================ */
document.getElementById("deleteNoteBtn").onclick = () => {
  if (!editingNoteId) return;
  const n = notes.find(x => x.id === editingNoteId);
  if (!n) return;

  archive.push(n);
  notes = notes.filter(x => x.id !== editingNoteId);

  localStorage.setItem("notes", JSON.stringify(notes));
  localStorage.setItem("archive", JSON.stringify(archive));

  document.getElementById("noteEditor").style.display = "none";
  renderNotes();
};

/* ============================================================
   ANNULLA EDITOR
   ============================================================ */
document.getElementById("cancelBtn").onclick = () => {
  document.getElementById("noteEditor").style.display = "none";
};

/* ============================================================
   ARCHIVIO
   ============================================================ */
document.getElementById("settingsArchive").onclick = () => {
  const list = document.getElementById("archiveList");
  if (!list) return;
  list.innerHTML = "";
  archive.forEach(n => {
    const div = document.createElement("div");
    div.innerHTML = `<b>${n.title}</b><br>${n.text.slice(0, 100)}...`;
    div.style.marginBottom = "10px";
    list.appendChild(div);
  });
  document.getElementById("archivePopup").style.display = "flex";
};

document.getElementById("archiveCloseBtn").onclick = () => {
  document.getElementById("archivePopup").style.display = "none";
};

/* ============================================================
   BANNER
   ============================================================ */
function showBanner(msg) {
  const b = document.getElementById("bannerMsg");
  if (!b) return;
  b.textContent = msg;
  b.classList.add("show");
  setTimeout(() => b.classList.remove("show"), 1500);
}

/* ============================================================
   IMPORT JSON
   ============================================================ */
document.getElementById("settingsImport").onclick = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);

        notes = data.notes || [];
        archive = data.archive || [];
        savedPIN = data.pin || "4618";
        currentLang = data.lang || "it";
        theme = data.theme || "light";
        amoled = data.amoled || false;

        localStorage.setItem("notes", JSON.stringify(notes));
        localStorage.setItem("archive", JSON.stringify(archive));
        localStorage.setItem("appPIN", savedPIN);
        localStorage.setItem("appLang", currentLang);
        localStorage.setItem("theme", theme);
        localStorage.setItem("amoled", amoled);

        applyTranslations();
        applyTheme();
        renderNotes();

        showBanner("Import riuscito");
      } catch {
        showBanner("Errore import");
      }
    };

    reader.readAsText(file);
  };

  input.click();
};

/* ============================================================
   RESET APP
   ============================================================ */
document.getElementById("settingsResetApp").onclick = () => {
  document.getElementById("resetPopup").style.display = "flex";
};

document.getElementById("resetCancelBtn").onclick = () => {
  document.getElementById("resetPopup").style.display = "none";
};

document.getElementById("resetConfirmBtn").onclick = () => {
  localStorage.clear();

  notes = [];
  archive = [];
  savedPIN = "4618";
  currentLang = "it";
  theme = "light";
  amoled = false;

  applyTranslations();
  applyTheme();
  renderNotes();

  document.getElementById("resetPopup").style.display = "none";
  showBanner("Reset completato");
};

/* ============================================================
   IMPOSTAZIONI AVANZATE
   ============================================================ */

/* FONT */
let currentFont = localStorage.getItem("font") || "-apple-system";

function applyFont() {
  document.body.style.fontFamily = currentFont;
}

document.getElementById("settingsFont").onclick = () => {
  const fonts = ["-apple-system", "Helvetica Neue", "Arial", "Georgia", "Courier New"];
  currentFont = fonts[(fonts.indexOf(currentFont) + 1) % fonts.length];
  localStorage.setItem("font", currentFont);
  applyFont();
  showBanner("Font cambiato");
};

/* DIMENSIONE TESTO */
let textSize = parseInt(localStorage.getItem("textSize") || "16");

function applyTextSize() {
  document.body.style.fontSize = textSize + "px";
}

document.getElementById("settingsTextSize").onclick = () => {
  textSize = textSize >= 22 ? 14 : textSize + 1;
  localStorage.setItem("textSize", textSize);
  applyTextSize();
  showBanner("Dimensione: " + textSize);
};

/* COLORE ACCENTO */
let accentColors = ["#4f8cff", "#ff3b30", "#ff9500", "#34c759", "#5856d6"];
let accentIndex = parseInt(localStorage.getItem("accentIndex") || "0");

function applyAccent() {
  document.documentElement.style.setProperty("--accent", accentColors[accentIndex]);
  document.documentElement.style.setProperty("--accent-light", accentColors[accentIndex] + "55");
  document.documentElement.style.setProperty("--accent-glow", accentColors[accentIndex] + "55");
}

document.getElementById("settingsAccent").onclick = () => {
  accentIndex = (accentIndex + 1) % accentColors.length;
  localStorage.setItem("accentIndex", accentIndex);
  applyAccent();
  showBanner("Colore cambiato");
};

/* BLUR */
let blurAmount = parseInt(localStorage.getItem("blur") || "18");

function applyBlur() {
  document.documentElement.style.setProperty("--blur-amount", blurAmount + "px");
}

document.getElementById("settingsBlur").onclick = () => {
  blurAmount = blurAmount >= 30 ? 6 : blurAmount + 2;
  localStorage.setItem("blur", blurAmount);
  applyBlur();
  showBanner("Blur: " + blurAmount);
};

/* ANIMAZIONI */
let animationsEnabled = localStorage.getItem("animations") !== "false";

function applyAnimations() {
  document.body.style.setProperty("--anim", animationsEnabled ? "1" : "0");
}

document.getElementById("settingsAnimations").onclick = () => {
  animationsEnabled = !animationsEnabled;
  localStorage.setItem("animations", animationsEnabled);
  applyAnimations();
  showBanner(animationsEnabled ? "Animazioni ON" : "Animazioni OFF");
};

/* HAPTICS (placeholder) */
let hapticsEnabled = localStorage.getItem("haptics") !== "false";

document.getElementById("settingsHaptics").onclick = () => {
  hapticsEnabled = !hapticsEnabled;
  localStorage.setItem("haptics", hapticsEnabled);
  showBanner(hapticsEnabled ? "Haptics ON" : "Haptics OFF");
};

/* ============================================================
   PANNELLO IMPOSTAZIONI (‚öôÔ∏è)
   ============================================================ */
document.getElementById("settingsBtn").onclick = () => {
  document.getElementById("settingsPanel").style.display = "flex";
};

document.querySelector("#settingsPanel .settingsClose").onclick = () => {
  document.getElementById("settingsPanel").style.display = "none";
};

/* ============================================================
   INIZIALIZZAZIONE FINALE
   ============================================================ */
applyTranslations();
applyTheme();
applyFont();
applyTextSize();
applyAccent();
applyBlur();
applyAnimations();
renderNotes();
   
