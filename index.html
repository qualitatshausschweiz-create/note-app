<!-- Schermata di blocco PIN -->
<div id="pinLockScreen">
  <div id="pinBlur"></div>

  <div id="pinContainer">
    <h2 id="pinTitle">PIN eingeben</h2>

    <div id="pinCircles">
      <div class="pinCircle"></div>
      <div class="pinCircle"></div>
      <div class="pinCircle"></div>
      <div class="pinCircle"></div>
    </div>

    <div id="pinKeypad">
      <button class="pinKey">1</button>
      <button class="pinKey">2</button>
      <button class="pinKey">3</button>
      <button class="pinKey">4</button>
      <button class="pinKey">5</button>
      <button class="pinKey">6</button>
      <button class="pinKey">7</button>
      <button class="pinKey">8</button>
      <button class="pinKey">9</button>

      <div class="pinEmpty"></div>
      <button class="pinKey">0</button>
      <button id="pinDelete">⌫</button>
    </div>

    <button id="pinResetBtn">App zurücksetzen</button>
  </div>
</div>
/* ================================
   SCHERMATA DI BLOCCO PIN (iOS)
   ================================ */

#pinLockScreen {
  position: fixed;
  inset: 0;
  display: none;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(12px);
  background: rgba(0,0,0,0.25); /* A1: blur + leggero scurimento */
  z-index: 9999;
}

#pinContainer {
  text-align: center;
  width: 90%;
  max-width: 360px;
  color: white;
}

#pinTitle {
  font-size: 24px;
  margin-bottom: 20px;
  font-weight: 600;
}

/* Cerchi grandi */
#pinCircles {
  display: flex;
  justify-content: center;
  gap: 18px;
  margin-bottom: 25px;
}

.pinCircle {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 2px solid white;
  background: transparent;
  transition: background 0.2s;
}

.pinCircle.filled {
  background: white;
}

/* Tastierino stile iOS */
#pinKeypad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 18px;
  margin: 25px auto;
  width: 90%;
  max-width: 300px;
}

.pinKey {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: white;
  color: black;
  font-size: 28px;
  border: none;
  font-weight: 500;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: transform 0.1s;
}

.pinKey:active {
  transform: scale(0.92);
}

/* Tasto delete */
#pinDelete {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: white;
  color: black;
  font-size: 26px;
  border: none;
  font-weight: 600;
}

/* Spazio vuoto */
.pinEmpty {
  width: 80px;
  height: 80px;
}

/* Pulsante reset */
#pinResetBtn {
  margin-top: 15px;
  background: transparent;
  border: none;
  color: white;
  font-size: 15px;
  text-decoration: underline;
  opacity: 0.8;
}

/* Shake forte */
.shake {
  animation: shakeAnim 0.4s ease;
}

@keyframes shakeAnim {
  0% { transform: translateX(0); }
  20% { transform: translateX(-18px); }
  40% { transform: translateX(18px); }
  60% { transform: translateX(-12px); }
  80% { transform: translateX(12px); }
  100% { transform: translateX(0); }
}
/* ================================
   SISTEMA DI BLOCCO PIN (iOS)
   ================================ */

let pinInput = "";
let isCreatingPIN = false;
let isConfirmingPIN = false;
let tempNewPIN = "";
let pinTimeout = localStorage.getItem("pinTimeout") || "immediately";
let lastActiveTime = Date.now();

/* --- Utility vibrazione --- */
function vibrate(ms) {
  if (navigator.vibrate) navigator.vibrate(ms);
}

/* --- Mostra schermata PIN --- */
function showPinLock() {
  pinInput = "";
  updatePinCircles();
  document.getElementById("pinLockScreen").style.display = "flex";
}

/* --- Nasconde schermata PIN --- */
function hidePinLock() {
  document.getElementById("pinLockScreen").style.display = "none";
}

/* --- Aggiorna cerchi --- */
function updatePinCircles() {
  const circles = document.querySelectorAll(".pinCircle");
  circles.forEach((c, i) => {
    c.classList.toggle("filled", i < pinInput.length);
  });
}

/* --- Shake forte --- */
function triggerShake() {
  const container = document.getElementById("pinContainer");
  container.classList.add("shake");
  vibrate(120);

  setTimeout(() => {
    container.classList.remove("shake");
  }, 400);
}

/* --- Verifica PIN --- */
function verifyPIN() {
  const savedPIN = localStorage.getItem("appPIN");

  if (!savedPIN) return;

  if (pinInput === savedPIN) {
    hidePinLock();
    pinInput = "";
    updatePinCircles();
    return;
  }

  // PIN errato
  triggerShake();
  pinInput = "";
  updatePinCircles();
}

/* --- Creazione PIN --- */
function startCreatePIN() {
  isCreatingPIN = true;
  isConfirmingPIN = false;
  pinInput = "";
  updatePinCircles();
  document.getElementById("pinTitle").textContent = "Neuen PIN erstellen";
  showPinLock();
}

function handleCreatePIN() {
  if (!isConfirmingPIN) {
    tempNewPIN = pinInput;
    pinInput = "";
    updatePinCircles();
    isConfirmingPIN = true;
    document.getElementById("pinTitle").textContent = "PIN bestätigen";
    return;
  }

  if (pinInput === tempNewPIN) {
    localStorage.setItem("appPIN", pinInput);
    isCreatingPIN = false;
    isConfirmingPIN = false;
    hidePinLock();
  } else {
    triggerShake();
    pinInput = "";
    updatePinCircles();
  }
}

/* --- Timeout blocco --- */
function shouldLockApp() {
  if (!localStorage.getItem("appPIN")) return false;

  const now = Date.now();
  const diff = now - lastActiveTime;

  switch (pinTimeout) {
    case "immediately":
      return true;
    case "30s":
      return diff > 30000;
    case "1min":
      return diff > 60000;
    case "5min":
      return diff > 300000;
  }
  return true;
}

document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    lastActiveTime = Date.now();
  } else {
    if (shouldLockApp()) showPinLock();
  }
});

/* --- Tastierino numerico --- */
document.querySelectorAll(".pinKey").forEach(btn => {
  btn.addEventListener("click", () => {
    vibrate(30);

    if (pinInput.length < 4) {
      pinInput += btn.textContent;
      updatePinCircles();
    }

    if (pinInput.length === 4) {
      if (isCreatingPIN) {
        handleCreatePIN();
      } else {
        verifyPIN();
      }
    }
  });
});

/* --- Cancella --- */
document.getElementById("pinDelete").addEventListener("click", () => {
  vibrate(20);
  pinInput = pinInput.slice(0, -1);
  updatePinCircles();
});

/* --- Reset app --- */
document.getElementById("pinResetBtn").addEventListener("click", () => {
  if (confirm("App wirklich zurücksetzen?")) {
    localStorage.clear();
    location.reload();
  }
});

/* --- Blocco all’avvio --- */
window.addEventListener("load", () => {
  if (localStorage.getItem("appPIN")) {
    showPinLock();
  }
});
/* ================================
   INTEGRAZIONE MENU IMPOSTAZIONI
   ================================ */

/* --- Switch attiva/disattiva PIN --- */
const pinSwitch = document.getElementById("pinEnabledSwitch");

if (localStorage.getItem("appPIN")) {
  pinSwitch.checked = true;
}

pinSwitch.addEventListener("change", () => {
  if (pinSwitch.checked) {
    startCreatePIN();
  } else {
    if (confirm("PIN wirklich deaktivieren?")) {
      localStorage.removeItem("appPIN");
      alert("PIN deaktiviert");
    } else {
      pinSwitch.checked = true;
    }
  }
});

/* --- Timeout blocco --- */
const timeoutSelect = document.getElementById("pinTimeoutSelect");
timeoutSelect.value = pinTimeout;

timeoutSelect.addEventListener("change", () => {
  pinTimeout = timeoutSelect.value;
  localStorage.setItem("pinTimeout", pinTimeout);
});

/* --- Cambio PIN --- */
document.getElementById("changePinBtn").addEventListener("click", () => {
  if (!localStorage.getItem("appPIN")) {
    alert("Kein PIN gesetzt");
    return;
  }

  // Richiede PIN attuale
  isCreatingPIN = false;
  isConfirmingPIN = false;
  pinInput = "";
  updatePinCircles();
  document.getElementById("pinTitle").textContent = "Aktuellen PIN eingeben";
  showPinLock();

  // Quando il PIN è corretto → crea nuovo PIN
  const originalVerify = verifyPIN;
  verifyPIN = function () {
    const savedPIN = localStorage.getItem("appPIN");

    if (pinInput === savedPIN) {
      // Ripristina funzione originale
      verifyPIN = originalVerify;

      // Avvia creazione nuovo PIN
      startCreatePIN();
    } else {
      triggerShake();
      pinInput = "";
      updatePinCircles();
    }
  };
});
/* ================================
   INTEGRAZIONE MENU IMPOSTAZIONI
   ================================ */

/* --- Switch attiva/disattiva PIN --- */
const pinSwitch = document.getElementById("pinEnabledSwitch");

if (localStorage.getItem("appPIN")) {
  pinSwitch.checked = true;
}

pinSwitch.addEventListener("change", () => {
  if (pinSwitch.checked) {
    startCreatePIN();
  } else {
    if (confirm("PIN wirklich deaktivieren?")) {
      localStorage.removeItem("appPIN");
      alert("PIN deaktiviert");
    } else {
      pinSwitch.checked = true;
    }
  }
});

/* --- Timeout blocco --- */
const timeoutSelect = document.getElementById("pinTimeoutSelect");
timeoutSelect.value = pinTimeout;

timeoutSelect.addEventListener("change", () => {
  pinTimeout = timeoutSelect.value;
  localStorage.setItem("pinTimeout", pinTimeout);
});

/* --- Cambio PIN --- */
document.getElementById("changePinBtn").addEventListener("click", () => {
  if (!localStorage.getItem("appPIN")) {
    alert("Kein PIN gesetzt");
    return;
  }

  // Richiede PIN attuale
  isCreatingPIN = false;
  isConfirmingPIN = false;
  pinInput = "";
  updatePinCircles();
  document.getElementById("pinTitle").textContent = "Aktuellen PIN eingeben";
  showPinLock();

  // Quando il PIN è corretto → crea nuovo PIN
  const originalVerify = verifyPIN;
  verifyPIN = function () {
    const savedPIN = localStorage.getItem("appPIN");

    if (pinInput === savedPIN) {
      // Ripristina funzione originale
      verifyPIN = originalVerify;

      // Avvia creazione nuovo PIN
      startCreatePIN();
    } else {
      triggerShake();
      pinInput = "";
      updatePinCircles();
    }
  };
});
