<!-- FOGLIO iOS PER SCELTA CATEGORIA (80% larghezza) -->
<div id="categorySheetOverlay" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.35);
  display: none;
  z-index: 1200;
"></div>

<div id="categorySheet" style="
  position: fixed;
  bottom: -420px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  max-width: 420px;
  background: var(--card);
  border-top-left-radius: 22px;
  border-top-right-radius: 22px;
  box-shadow: 0 -4px 18px rgba(0,0,0,0.25);
  padding: 20px;
  z-index: 1300;
  transition: bottom 0.28s ease;
">

  <h2 id="categorySheetTitle" style="
    text-align:center;
    margin-top:0;
    margin-bottom:18px;
    font-size:20px;
    font-weight:600;
  ">Kategorie wählen</h2>

  <div id="categorySheetButtons" style="
    display:flex;
    flex-direction:column;
    gap:12px;
  ">

    <button class="sheetCatBtn" data-cat="arbeit" style="
      padding:14px;
      border-radius:14px;
      border:none;
      background:#007aff;
      color:white;
      font-size:18px;
    ">Arbeit</button>

    <button class="sheetCatBtn" data-cat="einkauf" style="
      padding:14px;
      border-radius:14px;
      border:none;
      background:#ffcc00;
      color:black;
      font-size:18px;
    ">Einkauf</button>

    <button class="sheetCatBtn" data-cat="zuhause" style="
      padding:14px;
      border-radius:14px;
      border:none;
      background:#ff9500;
      color:white;
      font-size:18px;
    ">Zuhause</button>

    <button class="sheetCatBtn" data-cat="ideen" style="
      padding:14px;
      border-radius:14px;
      border:none;
      background:#34c759;
      color:white;
      font-size:18px;
    ">Ideen</button>

    <button class="sheetCatBtn" data-cat="personlich" style="
      padding:14px;
      border-radius:14px;
      border:none;
      background:#ffffff;
      color:black;
      font-size:18px;
      border:1px solid #ccc;
    ">Persönlich</button>

  </div>

  <button id="categorySheetCancel" style="
    margin-top:18px;
    width:100%;
    padding:14px;
    border-radius:14px;
    border:none;
    background:#ccc;
    color:black;
    font-size:18px;
  ">Abbrechen</button>

</div>
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* -------------------------
     DIZIONARIO LINGUE
  ------------------------- */
  const LANG = {
    de: {
      appTitle: "Notizen",
      newNote: "Neue Notiz",
      cancel: "Abbrechen",
      save: "Speichern",
      chooseCategory: "Kategorie wählen",
      categories: {
        favorite: "Favoriten",
        alle: "Alle",
        arbeit: "Arbeit",
        einkauf: "Einkauf",
        zuhause: "Zuhause",
        ideen: "Ideen",
        personlich: "Persönlich"
      },
      backup: {
        title: "Sicherung",
        autoBackup: "Backup automatisch",
        manualBackup: "Backup manuell",
        autoRestore: "Wiederherstellung automatisch",
        manualRestore: "Wiederherstellung manuell",
        close: "Schliessen"
      }
    },

    it: {
      appTitle: "Note",
      newNote: "Nuova nota",
      cancel: "Annulla",
      save: "Salva",
      chooseCategory: "Scegli categoria",
      categories: {
        favorite: "Preferiti",
        alle: "Tutte",
        arbeit: "Lavoro",
        einkauf: "Spesa",
        zuhause: "Casa",
        ideen: "Idee",
        personlich: "Personale"
      },
      backup: {
        title: "Backup",
        autoBackup: "Backup automatico",
        manualBackup: "Backup manuale",
        autoRestore: "Ripristino automatico",
        manualRestore: "Ripristino manuale",
        close: "Chiudi"
      }
    },

    en: {
      appTitle: "Notes",
      newNote: "New Note",
      cancel: "Cancel",
      save: "Save",
      chooseCategory: "Choose category",
      categories: {
        favorite: "Favorites",
        alle: "All",
        arbeit: "Work",
        einkauf: "Shopping",
        zuhause: "Home",
        ideen: "Ideas",
        personlich: "Personal"
      },
      backup: {
        title: "Backup",
        autoBackup: "Automatic Backup",
        manualBackup: "Manual Backup",
        autoRestore: "Automatic Restore",
        manualRestore: "Manual Restore",
        close: "Close"
      }
    },

    es: {
      appTitle: "Notas",
      newNote: "Nueva nota",
      cancel: "Cancelar",
      save: "Guardar",
      chooseCategory: "Elegir categoría",
      categories: {
        favorite: "Favoritos",
        alle: "Todas",
        arbeit: "Trabajo",
        einkauf: "Compras",
        zuhause: "Casa",
        ideen: "Ideas",
        personlich: "Personal"
      },
      backup: {
        title: "Copia de seguridad",
        autoBackup: "Copia automática",
        manualBackup: "Copia manual",
        autoRestore: "Restauración automática",
        manualRestore: "Restauración manual",
        close: "Cerrar"
      }
    }
  };

  /* -------------------------
     MULTILINGUA
  ------------------------- */
  function applyLanguage(lang) {
    const L = LANG[lang];

    document.getElementById("appTitle").textContent = L.appTitle;
    document.getElementById("editorTitle").textContent = L.newNote;
    document.getElementById("cancelBtn").textContent = L.cancel;
    document.getElementById("saveBtn").textContent = L.save;

    // categorie griglia
    document.querySelectorAll(".cat").forEach(btn => {
      const key = btn.dataset.cat;
      btn.querySelector(".catLabel").textContent = L.categories[key];
    });

    // foglio iOS
    document.getElementById("categorySheetTitle").textContent = L.chooseCategory;
    document.querySelectorAll(".sheetCatBtn").forEach(btn => {
      const key = btn.dataset.cat;
      btn.textContent = L.categories[key];
    });

    // backup
    document.querySelector("#backupBox h2").textContent = L.backup.title;
    document.querySelector("#autoBackupBtn span").textContent = L.backup.autoBackup;
    document.querySelector("#manualBackupBtn span").textContent = L.backup.manualBackup;
    document.querySelector("#autoRestoreBtn span").textContent = L.backup.autoRestore;
    document.querySelector("#manualRestoreBtn span").textContent = L.backup.manualRestore;
    document.querySelector("#backupCloseBtn span").textContent = L.backup.close;

    localStorage.setItem("lang", lang);
  }

  /* -------------------------
     FIX COLORE TESTO NOTE
  ------------------------- */
  function getTextColor(bg) {
    const c = bg.substring(1);
    const rgb = parseInt(c, 16);
    const r = (rgb >> 16) & 255;
    const g = (rgb >> 8) & 255;
    const b = rgb & 255;
    const luminance = (0.299*r + 0.587*g + 0.114*b);
    return luminance > 150 ? "#000" : "#fff";
  }

  /* -------------------------
     RIFERIMENTI DOM
  ------------------------- */
  const notesList       = document.getElementById("notesList");
  const noteEditor      = document.getElementById("noteEditor");
  const noteText        = document.getElementById("noteText");
  const cancelBtn       = document.getElementById("cancelBtn");
  const saveBtn         = document.getElementById("saveBtn");

  const categorySheetOverlay = document.getElementById("categorySheetOverlay");
  const categorySheet        = document.getElementById("categorySheet");
  const categorySheetCancel  = document.getElementById("categorySheetCancel");

  const backupBtn       = document.getElementById("backupBtn");
  const backupPopup     = document.getElementById("backupPopup");
  const backupCloseBtn  = document.getElementById("backupCloseBtn");

  const autoBackupBtn   = document.getElementById("autoBackupBtn");
  const manualBackupBtn = document.getElementById("manualBackupBtn");
  const autoRestoreBtn  = document.getElementById("autoRestoreBtn");
  const manualRestoreBtn= document.getElementById("manualRestoreBtn");

  const backupFile      = document.getElementById("backupFile");

  const langPopup       = document.getElementById("langPopup");
  const langBtn         = document.getElementById("langBtn");
  const langCloseBtn    = document.getElementById("langCloseBtn");

  const themeToggle     = document.getElementById("themeToggle");
  const addNoteBtn      = document.getElementById("addNoteBtn");

  let editingIndex   = null;
  let currentCategory = "alle";
  let selectedColor   = "#ffffff";
  let pendingCategory = null;

  /* -------------------------
     LOCAL STORAGE
  ------------------------- */
  function loadNotes() {
    try {
      return JSON.parse(localStorage.getItem("notes") || "[]");
    } catch {
      return [];
    }
  }

  function saveNotes(arr) {
    localStorage.setItem("notes", JSON.stringify(arr));
  }

  /* -------------------------
     MOSTRA NOTE
  ------------------------- */
  function showNotes(cat) {
    const notes = loadNotes();

    const filtered =
      cat === "alle"
        ? notes
        : cat === "favorite"
          ? notes.filter(n => n.favorite)
          : notes.filter(n => n.category === cat);

    notesList.innerHTML = "";
    notesList.style.display = filtered.length ? "block" : "none";

    filtered.forEach((n, idx) => {
      const div = document.createElement("div");
      div.className = "noteItem";
      div.style.background = n.color || "#ffffff";
      div.style.color = getTextColor(n.color || "#ffffff");

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "space-between";

      const textDiv = document.createElement("div");
      textDiv.textContent = n.text;
      textDiv.style.flex = "1";

      const star = document.createElement("span");
      star.textContent = n.favorite ? "★" : "☆";
      star.style.fontSize = "22px";
      star.style.cursor = "pointer";
      star.style.marginLeft = "12px";

      star.onclick = (e) => {
        e.stopPropagation();
        n.favorite = !n.favorite;

        const allNotes = loadNotes();
        const realIndex = allNotes.indexOf(filtered[idx]);
        if (realIndex !== -1) {
          allNotes[realIndex].favorite = n.favorite;
          saveNotes(allNotes);
        }
        showNotes(currentCategory);
      };

      row.appendChild(textDiv);
      row.appendChild(star);
      div.appendChild(row);

      div.onclick = () => {
        const allNotes = loadNotes();
        const realIndex = allNotes.indexOf(filtered[idx]);
        openEditor(false, realIndex);
      };

      notesList.appendChild(div);
    });
  }

  /* -------------------------
     EDITOR NOTE
  ------------------------- */
  function openEditor(isNew, index) {
    noteEditor.style.display = "flex";

    if (isNew) {
      noteText.value = "";
      selectedColor = "#ffffff";
      editingIndex = null;
    } else {
      const notes = loadNotes();
      const n = notes[index];
      if (!n) return;

      noteText.value = n.text;
      selectedColor = n.color || "#ffffff";
      editingIndex = index;
    }
  }

  cancelBtn.onclick = () => {
    noteEditor.style.display = "none";
  };

  saveBtn.onclick = () => {
    const text = noteText.value.trim();
    if (!text) {
      noteEditor.style.display = "none";
      return;
    }

    const notes = loadNotes();

    if (editingIndex === null) {
      notes.push({
        text,
        color: selectedColor,
        category: pendingCategory,
        favorite: false
      });

    } else {
      if (!notes[editingIndex]) {
        noteEditor.style.display = "none";
        return;
      }
      notes[editingIndex].text  = text;
      notes[editingIndex].color = selectedColor;
    }

    saveNotes(notes);
    noteEditor.style.display = "none";
    showNotes(currentCategory);
  };

  /* -------------------------
     COLORI
  ------------------------- */
  document.querySelectorAll(".colorDot").forEach(dot => {
    dot.addEventListener("click", () => {
      selectedColor = dot.dataset.color;
      document.querySelectorAll(".colorDot").forEach(d => d.classList.remove("selected"));
      dot.classList.add("selected");
    });
  });

  /* -------------------------
     CATEGORIE — FIX iPHONE
  ------------------------- */
  document.querySelectorAll(".cat").forEach(catEl => {

    catEl.addEventListener("touchstart", () => {
      currentCategory = catEl.dataset.cat;
      showNotes(currentCategory);
    }, { passive: true });

    catEl.addEventListener("click", () => {
      currentCategory = catEl.dataset.cat;
      showNotes(currentCategory);
    });

  });

  /* -------------------------
     FOGLIO iOS — APERTURA
  ------------------------- */
  function openCategorySheet() {
    categorySheetOverlay.style.display = "block";
    setTimeout(() => {
      categorySheet.style.bottom = "0px";
    }, 10);
  }

  function closeCategorySheet() {
    categorySheet.style.bottom = "-420px";
    setTimeout(() => {
      categorySheetOverlay.style.display = "none";
    }, 280);
  }

  categorySheetOverlay.onclick = closeCategorySheet;
  categorySheetCancel.onclick = closeCategorySheet;

  /* -------------------------
     SCELTA CATEGORIA DAL FOGLIO
  ------------------------- */
  document.querySelectorAll(".sheetCatBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      pendingCategory = btn.dataset.cat;
      closeCategorySheet();
      openEditor(true, null);
    });
  });

  /* -------------------------
     NUOVA NOTA
  ------------------------- */
  addNoteBtn.onclick = () => {
    if (currentCategory === "alle") {
      openCategorySheet();
    } else if (currentCategory === "favorite") {
      alert("Non puoi creare note nei Preferiti.");
    } else {
      pendingCategory = currentCategory;
      openEditor(true, null);
    }
  };

  /* -------------------------
     LINGUA
  ------------------------- */
  langBtn.onclick = () => {
    langPopup.style.display = "flex";
  };

  langCloseBtn.onclick = () => {
    langPopup.style.display = "none";
  };

  document.querySelectorAll(".langChoice[data-lang]").forEach(btn => {
    btn.addEventListener("click", () => {
      applyLanguage(btn.dataset.lang);
      langPopup.style.display = "none";
    });
  });

  /* -------------------------
     TEMA
  ------------------------- */
  themeToggle.onclick = () => {
    document.body.classList.toggle("dark");
  };

  /* -------------------------
     BACKUP (non toccato)
  ------------------------- */
  backupBtn.onclick = () => {
    backupPopup.style.display = "flex";
  };

  backupCloseBtn.onclick = () => {
    backupPopup.style.display = "none";
  };

  autoBackupBtn.onclick = () => {
    const notes = localStorage.getItem("notes") || "[]";
    localStorage.setItem("autoBackup", notes);
    alert("Backup gespeichert.");
  };

  manualBackupBtn.onclick = () => {
    const notes = localStorage.getItem("notes") || "[]";
    const blob = new Blob([notes], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "backup-notes.json";
    a.click();

    URL.revokeObjectURL(url);
  };

  autoRestoreBtn.onclick = () => {
    const data = localStorage.getItem("autoBackup");
    if (!data) {
      alert("Kein Backup gefunden.");
      return;
    }
    try {
      const arr = JSON.parse(data);
      if (Array.isArray(arr)) {
        saveNotes(arr);
        showNotes(currentCategory);
        alert("Wiederhergestellt.");
      }
    } catch {
      alert("Fehler.");
    }
  };

  manualRestoreBtn.onclick = () => {
    backupFile.click();
  };

  backupFile.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse
