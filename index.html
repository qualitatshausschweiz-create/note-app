<script>
let editingIndex = null;
let currentCategory = null;

const editor = document.getElementById("noteEditor");
const noteText = document.getElementById("noteText");
const editorTitle = document.getElementById("editorTitle");
const notesList = document.getElementById("notesList");
const categories = document.getElementById("categories");
const sunIcon = document.getElementById("sunIcon");

document.getElementById("addNoteBtn").onclick = () => {
    editorTitle.textContent = "Nuova Nota";
    noteText.value = "";

    if (!currentCategory || currentCategory === "tutte") {
        currentCategory = "generale";
    }

    editor.style.display = "flex";
    editingIndex = null;
};

document.querySelectorAll(".cat").forEach(cat => {
    cat.addEventListener("click", () => {
        currentCategory = cat.dataset.cat;
        showNotes(currentCategory);
    });
});

function closeEditor() {
    editor.style.display = "none";
}

function saveNote() {
    const text = noteText.value.trim();
    if (!text) return;

    const notes = JSON.parse(localStorage.getItem("notes") || "[]");

    if (editingIndex !== null) {
        notes[editingIndex].text = text;
    } else {
        notes.push({
            text,
            category: currentCategory,
            date: Date.now()
        });
    }

    localStorage.setItem("notes", JSON.stringify(notes));
    editor.style.display = "none";
    showNotes(currentCategory);
}

function showNotes(category) {
    currentCategory = category;
    categories.style.display = "none";
    notesList.style.display = "block";

    const notes = JSON.parse(localStorage.getItem("notes") || "[]");

    let filtered = notes;
    if (category !== "tutte") {
        filtered = notes.filter(n => n.category === category);
    }

    let html = `
        <button class="backBtn" onclick="goBack()">Indietro</button>
        <input id="searchBar" placeholder="üîé Cerca..." oninput="filterNotes(this.value)">
        <div id="notesContainer">
    `;

    filtered.forEach((n, i) => {
        const originalIndex = notes.indexOf(n);
        html += `
            <div class="noteItem" data-index="${originalIndex}">
                <b>${getIcon(n.category)}</b> ${n.text}
                <div class="noteActions">
                    <button class="actionBtn editBtn" onclick="editNote(${originalIndex})">‚úèÔ∏è Modifica</button>
                    <button class="actionBtn deleteBtn" onclick="deleteNote(${originalIndex})">üóëÔ∏è Elimina</button>
                </div>
            </div>
        `;
    });

    html += "</div>";
    notesList.innerHTML = html;
}

function filterNotes(query) {
    const items = document.querySelectorAll(".noteItem");
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(query.toLowerCase()) ? "block" : "none";
    });
}

function editNote(index) {
    const notes = JSON.parse(localStorage.getItem("notes") || "[]");
    editingIndex = index;
    noteText.value = notes[index].text;
    editorTitle.textContent = "Modifica Nota";
    editor.style.display = "flex";
}

function deleteNote(index) {
    const notes = JSON.parse(localStorage.getItem("notes") || "[]");
    notes.splice(index, 1);
    localStorage.setItem("notes", JSON.stringify(notes));
    showNotes(currentCategory);
}

function goBack() {
    notesList.style.display = "none";
    categories.style.display = "grid";
    currentCategory = null;
}

function getIcon(cat) {
    return {
        lavoro: "üíº",
        spesa: "üõí",
        casa: "üè†",
        idee: "üí°",
        personale: "‚≠ê",
        generale: "üìù"
    }[cat] || "üìÑ";
}

// ‚≠ê TEMA SCURO + SOLE ‚≠ê
document.getElementById("themeToggle").onclick = () => {
    document.body.classList.toggle("dark");

    const isDark = document.body.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");

    sunIcon.style.display = isDark ? "inline" : "none";
};

if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
    sunIcon.style.display = "inline";
}
</script>
