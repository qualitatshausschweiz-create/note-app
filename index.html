<script>
/* ============================================================
   BLOCCO 3.1 ‚Äî PIN + TRADUZIONI + TEMA
   ============================================================ */

/* ------------------------------------------------------------
   PIN SYSTEM ‚Äî PIN iniziale 4618 + PIN personalizzabile
   ------------------------------------------------------------ */
let savedPIN = localStorage.getItem("appPIN") || "4618";
let enteredPIN = "";

const pinOverlay = document.getElementById("pinOverlay");
const pinCircles = document.querySelectorAll(".pinCircle");
const pinError = document.getElementById("pinError");

function updatePinCircles() {
  pinCircles.forEach((c, i) => {
    c.classList.toggle("filled", i < enteredPIN.length);
  });
}

function checkPIN() {
  if (enteredPIN === savedPIN) {
    pinOverlay.style.display = "none";
    enteredPIN = "";
    updatePinCircles();
  } else {
    pinError.textContent = "Falscher PIN";
    pinError.style.opacity = 1;
    setTimeout(() => {
      pinError.style.opacity = 0;
      enteredPIN = "";
      updatePinCircles();
    }, 900);
  }
}

document.querySelectorAll(".pinKey").forEach(btn => {
  btn.addEventListener("click", () => {
    const digit = btn.dataset.digit;

    if (digit) {
      if (enteredPIN.length < 4) {
        enteredPIN += digit;
        updatePinCircles();
        if (enteredPIN.length === 4) checkPIN();
      }
    }
  });
});

document.getElementById("pinBackspace").addEventListener("click", () => {
  enteredPIN = enteredPIN.slice(0, -1);
  updatePinCircles();
});

/* Cambia PIN */
function changePIN(newPIN) {
  savedPIN = newPIN;
  localStorage.setItem("appPIN", newPIN);
}

/* ------------------------------------------------------------
   TRADUZIONI MULTILINGUE (DE / IT / EN)
   ------------------------------------------------------------ */
const translations = {
  de: {
    title: "Notizen",
    premium: "Premium",
    newNote: "Neue Notiz",
    save: "Speichern",
    cancel: "Abbrechen",
    delete: "L√∂schen",
    archive: "Archiv",
    info: "Info",
    reset: "App zur√ºcksetzen",
    theme: "Thema",
    amoled: "AMOLED",
    font: "Schriftart",
    textSize: "Textgr√∂√üe",
    accent: "Akzentfarbe",
    blur: "Hintergrund-Blur",
    animations: "Animationen",
    haptics: "Haptik",
    export: "Exportieren",
    import: "Importieren",
    changePin: "PIN √§ndern"
  },

  it: {
    title: "Note",
    premium: "Premium",
    newNote: "Nuova nota",
    save: "Salva",
    cancel: "Annulla",
    delete: "Elimina",
    archive: "Archivio",
    info: "Info",
    reset: "Reset app",
    theme: "Tema",
    amoled: "AMOLED",
    font: "Font",
    textSize: "Dimensione testo",
    accent: "Colore accento",
    blur: "Sfocatura sfondo",
    animations: "Animazioni",
    haptics: "Feedback aptico",
    export: "Esporta",
    import: "Importa",
    changePin: "Cambia PIN"
  },

  en: {
    title: "Notes",
    premium: "Premium",
    newNote: "New Note",
    save: "Save",
    cancel: "Cancel",
    delete: "Delete",
    archive: "Archive",
    info: "Info",
    reset: "Reset App",
    theme: "Theme",
    amoled: "AMOLED",
    font: "Font",
    textSize: "Text Size",
    accent: "Accent Color",
    blur: "Background Blur",
    animations: "Animations",
    haptics: "Haptics",
    export: "Export",
    import: "Import",
    changePin: "Change PIN"
  }
};

let currentLang = localStorage.getItem("appLang") || "de";

function applyTranslations() {
  const t = translations[currentLang];

  document.getElementById("appTitle").childNodes[0].textContent = t.title;
  document.querySelector("#appTitle .sub").textContent = t.premium;

  document.getElementById("editorTitle").textContent = t.newNote;
  document.getElementById("saveBtn").textContent = t.save;
  document.getElementById("cancelBtn").textContent = t.cancel;
  document.getElementById("deleteNoteBtn").textContent = "üóë " + t.delete;

  document.getElementById("settingsTheme").textContent = t.theme;
  document.getElementById("settingsAmoled").textContent = t.amoled;
  document.getElementById("settingsFont").textContent = t.font;
  document.getElementById("settingsTextSize").textContent = t.textSize;
  document.getElementById("settingsAccent").textContent = t.accent;
  document.getElementById("settingsBlur").textContent = t.blur;
  document.getElementById("settingsAnimations").textContent = t.animations;
  document.getElementById("settingsHaptics").textContent = t.haptics;
  document.getElementById("settingsExport").textContent = t.export;
  document.getElementById("settingsImport").textContent = t.import;
  document.getElementById("settingsChangePin").textContent = t.changePin;
  document.getElementById("settingsArchive").textContent = t.archive;
  document.getElementById("settingsInfo").textContent = t.info;
  document.getElementById("settingsResetApp").textContent = t.reset;
}

document.getElementById("langBtn").addEventListener("click", () => {
  currentLang = currentLang === "de" ? "it" : currentLang === "it" ? "en" : "de";
  localStorage.setItem("appLang", currentLang);
  applyTranslations();
});

/* ------------------------------------------------------------
   TEMA (CHIARO / SCURO) + AMOLED
   ------------------------------------------------------------ */
let theme = localStorage.getItem("theme") || "light";
let amoled = localStorage.getItem("amoled") === "true";

function applyTheme() {
  document.body.classList.remove("dark", "amoled");

  if (amoled) {
    document.body.classList.add("amoled");
  } else if (theme === "dark") {
    document.body.classList.add("dark");
  }
}

document.getElementById("themeBtn").addEventListener("click", () => {
  theme = theme === "light" ? "dark" : "light";
  localStorage.setItem("theme", theme);
  applyTheme();
});

document.getElementById("settingsAmoled").addEventListener("click", () => {
  amoled = !amoled;
  localStorage.setItem("amoled", amoled);
  applyTheme();
});

/* Avvio iniziale */
applyTranslations();
applyTheme();
</script>
<script>
/* ============================================================
   BLOCCO 3.2 ‚Äî NOTE + EDITOR + PALETTE + ARCHIVIO
   ============================================================ */

let notes = JSON.parse(localStorage.getItem("notes") || "[]");
let archive = JSON.parse(localStorage.getItem("archive") || "[]");

let editingNoteId = null;
let selectedColor = "#007aff";

/* ------------------------------------------------------------
   PALETTE COLORI
   ------------------------------------------------------------ */
const palettes = {
  warm: ["#ff6b6b", "#ff9f43", "#ffa502", "#ff4757", "#eccc68"],
  cool: ["#1e90ff", "#3742fa", "#2ed573", "#70a1ff", "#5352ed"],
  pastel: ["#ffcccc", "#ffd3b6", "#dcedc1", "#a8e6cf", "#d4a5a5"],
  mix: ["#ff6b6b", "#1e90ff", "#2ed573", "#ffa502", "#a55eea"]
};

function loadPalette(pal) {
  const row = document.getElementById("colorRow");
  row.innerHTML = "";

  palettes[pal].forEach(color => {
    const dot = document.createElement("div");
    dot.className = "colorDot";
    dot.style.background = color;

    dot.addEventListener("click", () => {
      selectedColor = color;
      document.querySelectorAll(".colorDot").forEach(d => d.classList.remove("selected"));
      dot.classList.add("selected");
    });

    row.appendChild(dot);
  });
}

document.querySelectorAll(".paletteBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    loadPalette(btn.dataset.pal);
  });
});

/* ------------------------------------------------------------
   RENDER NOTE
   ------------------------------------------------------------ */
function renderNotes() {
  const list = document.getElementById("notesList");
  list.innerHTML = "";

  const activeCat = document.querySelector(".cat.active").dataset.cat;

  notes.forEach(note => {
    if (activeCat !== "all" && note.category !== activeCat) return;

    const item = document.createElement("div");
    item.className = "noteItem";
    item.style.borderLeftColor = note.color;

    item.innerHTML = `
      <div class="noteTitleRow">
        <div class="noteTitle">${note.title || "Ohne Titel"}</div>
        <div class="noteMeta">${note.date}</div>
      </div>
      <div class="noteTextPreview">${note.text.slice(0, 120)}</div>
    `;

    item.addEventListener("click", () => openEditor(note.id));

    list.appendChild(item);
  });
}

/* ------------------------------------------------------------
   CATEGORIE
   ------------------------------------------------------------ */
document.querySelectorAll(".cat").forEach(cat => {
  cat.addEventListener("click", () => {
    document.querySelectorAll(".cat").forEach(c => c.classList.remove("active"));
    cat.classList.add("active");
    renderNotes();
  });
});

/* ------------------------------------------------------------
   APRI EDITOR
   ------------------------------------------------------------ */
function openEditor(id = null) {
  editingNoteId = id;

  if (id) {
    const note = notes.find(n => n.id === id);
    document.getElementById("noteTitleInput").value = note.title;
    document.getElementById("noteText").value = note.text;
    selectedColor = note.color;
  } else {
    document.getElementById("noteTitleInput").value = "";
    document.getElementById("noteText").value = "";
    selectedColor = "#007aff";
  }

  loadPalette("mix");
  document.getElementById("noteEditor").style.display = "flex";
}

/* ------------------------------------------------------------
   SALVA NOTA
   ------------------------------------------------------------ */
document.getElementById("saveBtn").addEventListener("click", () => {
  const title = document.getElementById("noteTitleInput").value.trim();
  const text = document.getElementById("noteText").value.trim();

  if (!text) {
    showBanner("Notiz ist leer");
    return;
  }

  if (editingNoteId) {
    const note = notes.find(n => n.id === editingNoteId);
    note.title = title;
    note.text = text;
    note.color = selectedColor;
    note.date = new Date().toLocaleDateString();
  } else {
    notes.push({
      id: Date.now(),
      title,
      text,
      color: selectedColor,
      category: document.querySelector(".cat.active").dataset.cat,
      date: new Date().toLocaleDateString()
    });
  }

  localStorage.setItem("notes", JSON.stringify(notes));
  document.getElementById("noteEditor").style.display = "none";
  renderNotes();
});

/* ------------------------------------------------------------
   CANCELLA NOTA
   ------------------------------------------------------------ */
document.getElementById("deleteNoteBtn").addEventListener("click", () => {
  if (!editingNoteId) return;

  const note = notes.find(n => n.id === editingNoteId);
  archive.push(note);

  notes = notes.filter(n => n.id !== editingNoteId);

  localStorage.setItem("notes", JSON.stringify(notes));
  localStorage.setItem("archive", JSON.stringify(archive));

  document.getElementById("noteEditor").style.display = "none";
  renderNotes();
});

/* ------------------------------------------------------------
   CHIUDI EDITOR
   ------------------------------------------------------------ */
document.getElementById("cancelBtn").addEventListener("click", () => {
  document.getElementById("noteEditor").style.display = "none";
});

/* ------------------------------------------------------------
   ARCHIVIO
   ------------------------------------------------------------ */
document.getElementById("settingsArchive").addEventListener("click", () => {
  const list = document.getElementById("archiveList");
  list.innerHTML = "";

  archive.forEach(n => {
    const div = document.createElement("div");
    div.style.marginBottom = "10px";
    div.innerHTML = `<b>${n.title || "Ohne Titel"}</b><br>${n.text.slice(0, 100)}...`;
    list.appendChild(div);
  });

  document.getElementById("archivePopup").style.display = "flex";
});

document.getElementById("archiveCloseBtn").addEventListener("click", () => {
  document.getElementById("archivePopup").style.display = "none";
});

/* ------------------------------------------------------------
   ADD NOTE BUTTON
   ------------------------------------------------------------ */
document.getElementById("addNoteBtn").addEventListener("click", () => {
  openEditor(null);
});

/* ------------------------------------------------------------
   BANNER
   ------------------------------------------------------------ */
function showBanner(msg) {
  const b = document.getElementById("bannerMsg");
  b.textContent = msg;
  b.classList.add("show");
  setTimeout(() => b.classList.remove("show"), 1500);
}

/* ------------------------------------------------------------
   AVVIO
   ------------------------------------------------------------ */
renderNotes();
</script>
<script>
/* ============================================================
   BLOCCO 3.3.1 ‚Äî BACKUP + EXPORT
   ============================================================ */

/* ------------------------------------------------------------
   BACKUP AUTOMATICO
   ------------------------------------------------------------ */
function autoBackup() {
  const data = {
    notes,
    archive,
    pin: savedPIN,
    lang: currentLang,
    theme,
    amoled
  };
  localStorage.setItem("autoBackup", JSON.stringify(data));
}

setInterval(autoBackup, 5000); // backup ogni 5 secondi

/* ------------------------------------------------------------
   EXPORT ‚Äî Scarica file JSON
   ------------------------------------------------------------ */
document.getElementById("settingsExport").addEventListener("click", () => {
  const data = {
    notes,
    archive,
    pin: savedPIN,
    lang: currentLang,
    theme,
    amoled
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: "application/json"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "notizen_backup.json";
  a.click();
  URL.revokeObjectURL(url);

  showBanner("Export erfolgreich");
});
</script>
<script>
/* ============================================================
   BLOCCO 3.3.2 ‚Äî IMPORT + RESET APP
   ============================================================ */

/* ------------------------------------------------------------
   IMPORT ‚Äî Carica file JSON
   ------------------------------------------------------------ */
document.getElementById("settingsImport").addEventListener("click", () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = event => {
      try {
        const data = JSON.parse(event.target.result);

        if (data.notes) notes = data.notes;
        if (data.archive) archive = data.archive;
        if (data.pin) {
          savedPIN = data.pin;
          localStorage.setItem("appPIN", savedPIN);
        }
        if (data.lang) {
          currentLang = data.lang;
          localStorage.setItem("appLang", currentLang);
        }
        if (data.theme) {
          theme = data.theme;
          localStorage.setItem("theme", theme);
        }
        if (typeof data.amoled !== "undefined") {
          amoled = data.amoled;
          localStorage.setItem("amoled", amoled);
        }

        localStorage.setItem("notes", JSON.stringify(notes));
        localStorage.setItem("archive", JSON.stringify(archive));

        applyTranslations();
        applyTheme();
        renderNotes();

        showBanner("Import erfolgreich");
      } catch (err) {
        showBanner("Fehler beim Import");
      }
    };

    reader.readAsText(file);
  };

  input.click();
});

/* ------------------------------------------------------------
   RESET APP ‚Äî Cancella tutto
   ------------------------------------------------------------ */
document.getElementById("settingsResetApp").addEventListener("click", () => {
  document.getElementById("resetPopup").style.display = "flex";
});

document.getElementById("resetCancelBtn").addEventListener("click", () => {
  document.getElementById("resetPopup").style.display = "none";
});

document.getElementById("resetConfirmBtn").addEventListener("click", () => {
  localStorage.clear();

  notes = [];
  archive = [];
  savedPIN = "4618";
  currentLang = "de";
  theme = "light";
  amoled = false;

  localStorage.setItem("appPIN", "4618");
  localStorage.setItem("appLang", "de");
  localStorage.setItem("theme", "light");
  localStorage.setItem("amoled", "false");

  applyTranslations();
  applyTheme();
  renderNotes();

  document.getElementById("resetPopup").style.display = "none";
  showBanner("App zur√ºckgesetzt");
});
</script>
<script>
/* ============================================================
   BLOCCO 3.3.3 ‚Äî IMPOSTAZIONI AVANZATE
   ============================================================ */

/* ------------------------------------------------------------
   FONT SELECTOR
   ------------------------------------------------------------ */
let currentFont = localStorage.getItem("font") || "-apple-system";

function applyFont() {
  document.body.style.fontFamily = currentFont;
}

document.getElementById("settingsFont").addEventListener("click", () => {
  const fonts = [
    "-apple-system",
    "Helvetica Neue",
    "Arial",
    "Georgia",
    "Courier New"
  ];

  const next = (fonts.indexOf(currentFont) + 1) % fonts.length;
  currentFont = fonts[next];

  localStorage.setItem("font", currentFont);
  applyFont();
  showBanner("Font ge√§ndert");
});

/* ------------------------------------------------------------
   TEXT SIZE
   ------------------------------------------------------------ */
let textSize = parseInt(localStorage.getItem("textSize") || "16");

function applyTextSize() {
  document.documentElement.style.setProperty("--text-size", textSize + "px");
}

document.getElementById("settingsTextSize").addEventListener("click", () => {
  textSize += 1;
  if (textSize > 22) textSize = 14;

  localStorage.setItem("textSize", textSize);
  applyTextSize();
  showBanner("Textgr√∂√üe: " + textSize);
});

/* ------------------------------------------------------------
   ACCENT COLOR
   ------------------------------------------------------------ */
let accentColors = ["#007aff", "#ff3b30", "#ff9500", "#34c759", "#5856d6"];
let accentIndex = 0;

function applyAccent() {
  document.documentElement.style.setProperty("--accent", accentColors[accentIndex]);
  document.documentElement.style.setProperty("--accent-light", accentColors[accentIndex] + "55");
  document.documentElement.style.setProperty("--accent-glow", accentColors[accentIndex] + "55");
}

document.getElementById("settingsAccent").addEventListener("click", () => {
  accentIndex = (accentIndex + 1) % accentColors.length;
  localStorage.setItem("accentIndex", accentIndex);
  applyAccent();
  showBanner("Akzentfarbe ge√§ndert");
});

/* Carica accento salvato */
if (localStorage.getItem("accentIndex")) {
  accentIndex = parseInt(localStorage.getItem("accentIndex"));
  applyAccent();
}

/* ------------------------------------------------------------
   BACKGROUND BLUR
   ------------------------------------------------------------ */
let blurAmount = parseInt(localStorage.getItem("blur") || "18");

function applyBlur() {
  document.documentElement.style.setProperty("--blur-amount", blurAmount + "px");
}

document.getElementById("settingsBlur").addEventListener("click", () => {
  blurAmount += 2;
  if (blurAmount > 30) blurAmount = 6;

  localStorage.setItem("blur", blurAmount);
  applyBlur();
  showBanner("Blur: " + blurAmount);
});

/* ------------------------------------------------------------
   ANIMAZIONI ON/OFF
   ------------------------------------------------------------ */
let animationsEnabled = localStorage.getItem("animations") !== "false";

function applyAnimations() {
  document.body.style.setProperty("--anim", animationsEnabled ? "1" : "0");
}

document.getElementById("settingsAnimations").addEventListener("click", () => {
  animationsEnabled = !animationsEnabled;
  localStorage.setItem("animations", animationsEnabled);
  applyAnimations();
  showBanner(animationsEnabled ? "Animationen an" : "Animationen aus");
});

/* ------------------------------------------------------------
   HAPTIC FEEDBACK
   ------------------------------------------------------------ */
let hapticsEnabled = localStorage.getItem("haptics") !== "false";

function vibrate(ms = 30) {
  if (hapticsEnabled && navigator.vibrate) {
    navigator.vibrate(ms);
  }
}

document.getElementById("settingsHaptics").addEventListener("click", () => {
  hapticsEnabled = !hapticsEnabled;
  localStorage.setItem("haptics", hapticsEnabled);
  showBanner(hapticsEnabled ? "Haptik an" : "Haptik aus");
});

/* ------------------------------------------------------------
   CHIUSURA SETTINGS PANEL
   ------------------------------------------------------------ */
document.querySelector(".settingsClose").addEventListener("click", () => {
  document.getElementById("settingsPanel").style.display = "none";
});

/* ------------------------------------------------------------
   APERTURA SETTINGS PANEL
   ------------------------------------------------------------ */
document.getElementById("settingsBtn").addEventListener("click", () => {
  document.getElementById("settingsPanel").style.display = "flex";
});

/* ------------------------------------------------------------
   AVVIO
   ------------------------------------------------------------ */
applyFont();
applyTextSize();
applyAccent();
applyBlur();
applyAnimations();
</script>
