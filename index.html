<script>
let editingIndex = null;
let currentCategory = "alle";
let currentLang = localStorage.getItem("lang") || "de";
let selectedColor = "#ffffff";

/* Carica e salva note */
function loadNotes() {
  try {
    return JSON.parse(localStorage.getItem("notes") || "[]");
  } catch(e) {
    return [];
  }
}
function saveNotes(arr) {
  localStorage.setItem("notes", JSON.stringify(arr));
}

/* Timestamp */
function getTimestamp() {
  const d = new Date();
  const pad = n => (n < 10 ? "0" + n : n);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* Tema */
function applyTheme() {
  const theme = localStorage.getItem("theme") || "light";
  if (theme === "dark") {
    document.body.classList.add("dark");
    themeToggle.textContent = "â˜€ï¸";
  } else {
    document.body.classList.remove("dark");
    themeToggle.textContent = "ðŸŒ™";
  }
}
themeToggle.onclick = () => {
  const theme = localStorage.getItem("theme") === "dark" ? "light" : "dark";
  localStorage.setItem("theme", theme);
  applyTheme();
};
/* Editor */
function openEditor(isNew, index) {
  noteEditor.style.display = "flex";
  if (isNew) {
    editorTitle.textContent = "Neue Notiz";
    noteText.value = "";
    selectedColor = "#ffffff";
    editingIndex = null;
  } else {
    const notes = loadNotes();
    const n = notes[index];
    editorTitle.textContent = "Notiz bearbeiten";
    noteText.value = n.text;
    selectedColor = n.color || "#ffffff";
    editingIndex = index;
  }
  updateColorDots();
}

function closeEditor() {
  noteEditor.style.display = "none";
  editingIndex = null;
}
cancelBtn.onclick = closeEditor;

saveBtn.onclick = () => {
  const text = noteText.value.trim();
  if (!text) { closeEditor(); return; }

  const notes = loadNotes();
  if (editingIndex === null) {
    notes.push({
      text,
      color: selectedColor,
      category: currentCategory || "alle",
      createdAt: getTimestamp(),
      favorite: false
    });
  } else {
    notes[editingIndex].text = text;
    notes[editingIndex].color = selectedColor;
  }
  saveNotes(notes);
  closeEditor();
  showNotes(currentCategory);
};

/* Colori */
function updateColorDots() {
  document.querySelectorAll(".colorDot").forEach(dot => {
    dot.classList.toggle("selected", dot.dataset.color === selectedColor);
  });
}
document.querySelectorAll(".colorDot").forEach(dot => {
  dot.addEventListener("click", () => {
    selectedColor = dot.dataset.color;
    updateColorDots();
  });
});

/* Categorie */
document.querySelectorAll(".cat").forEach(cat => {
  cat.addEventListener("click", () => {
    currentCategory = cat.dataset.cat;
    showNotes(currentCategory);
  });
});
/* â­ Mostra note con stellina funzionante */
function showNotes(cat) {
  const notes = loadNotes();

  const filtered =
    cat === "alle"
      ? notes
      : cat === "favorite"
        ? notes.filter(n => n.favorite)
        : notes.filter(n => n.category === cat);

  notesList.innerHTML = "";
  if (filtered.length === 0) {
    notesList.style.display = "none";
    return;
  }
  notesList.style.display = "block";

  filtered.forEach((n, idx) => {
    const div = document.createElement("div");
    div.className = "noteItem";
    div.style.background = n.color || "#ffffff";

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.justifyContent = "space-between";
    row.style.alignItems = "flex-start";

    const textDiv = document.createElement("div");
    textDiv.textContent = n.text;
    textDiv.style.whiteSpace = "pre-wrap";
    textDiv.style.flex = "1";

    const star = document.createElement("span");
    star.textContent = n.favorite ? "â˜…" : "â˜†";
    star.style.fontSize = "22px";
    star.style.cursor = "pointer";
    star.style.marginLeft = "12px";

    star.onclick = (e) => {
      e.stopPropagation();
      n.favorite = !n.favorite;
      saveNotes(notes);
      showNotes(currentCategory);
    };

    row.appendChild(textDiv);
    row.appendChild(star);
    div.appendChild(row);

    div.addEventListener("click", () => {
      const realIndex = notes.indexOf(filtered[idx]);
      openEditor(false, realIndex);
    });

    notesList.appendChild(div);
  });
}

/* Backup */
backupBtn.onclick = () => backupPopup.style.display = "flex";
backupCloseBtn.onclick = () => backupPopup.style.display = "none";

backupExportBtn.onclick = () => {
  const notes = localStorage.getItem("notes") || "[]";
  const blob = new Blob([notes], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "backup-notes.json";
  a.click();
};

backupFile.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (Array.isArray(data)) {
        saveNotes(data);
        showNotes(currentCategory);
      }
    } catch(err) {}
  };
  reader.readAsText(file);
  e.target.value = "";
});

/* Aggiungi nota */
addNoteBtn.onclick = () => openEditor(true, null);

/* Init */
document.addEventListener("DOMContentLoaded", () => {
  applyTheme();
  showNotes(currentCategory);
});
</script>
</body>
</html>
